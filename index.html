<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overpass AI</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-0: #141414;
      --bg-1: #1e1e1e;
      --bg-2: #272727;
      --bg-3: #303030;
      --bg-hover: #383838;
      --border: #383838;
      --border-mid: #444;
      --text-0: #e8e8e8;
      --text-1: #aaa;
      --text-2: #666;
      --accent: #0a84ff;
      --accent-h: #3a9dff;
      --danger: #c0392b;
      --radius: 3px;
    }

    html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 13px; background: var(--bg-0); color: var(--text-0); overflow: hidden; }

    /* ── Layout ────────────────────────────────────────────────── */
    .app { display: flex; flex-direction: column; height: 100vh; }

    .topbar {
      height: 40px; background: var(--bg-1); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 16px; gap: 12px; flex-shrink: 0;
    }
    .topbar-title { font-size: 14px; font-weight: 600; letter-spacing: 0.3px; }
    .topbar-spacer { flex: 1; }

    .layout { display: flex; flex: 1; overflow: hidden; }

    /* ── Panels ─────────────────────────────────────────────────── */
    .panel { background: var(--bg-1); display: flex; flex-direction: column; overflow: hidden; }
    .panel-left  { width: 330px; flex-shrink: 0; border-right: 1px solid var(--border); }
    .panel-right { width: 290px; flex-shrink: 0; border-left: 1px solid var(--border); }

    .panel-header {
      padding: 8px 14px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      color: var(--text-1); flex-shrink: 0;
    }

    .panel-body { flex: 1; overflow-y: auto; padding: 14px; }

    /* ── Typography helpers ─────────────────────────────────────── */
    .label {
      display: block; font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-1); margin-bottom: 5px;
    }
    .help-text { font-size: 11px; color: var(--text-2); margin-top: 5px; line-height: 1.5; }

    /* ── Form elements ──────────────────────────────────────────── */
    .form-group { margin-bottom: 14px; }

    textarea, input[type="text"], input[type="password"], select {
      width: 100%; background: var(--bg-3); border: 1px solid var(--border-mid);
      color: var(--text-0); border-radius: var(--radius); padding: 7px 10px;
      font-family: inherit; font-size: 13px; outline: none; transition: border-color .15s;
    }
    textarea { resize: vertical; min-height: 90px; }
    textarea:focus, input:focus, select:focus { border-color: var(--accent); }

    .example-list { display: flex; flex-direction: column; gap: 4px; margin-bottom: 14px; }
    .example-btn {
      text-align: left; background: var(--bg-2); border: 1px solid var(--border);
      color: var(--text-1); border-radius: var(--radius); padding: 5px 8px; font-size: 11px;
      cursor: pointer; font-family: inherit; transition: background .1s, color .1s;
    }
    .example-btn:hover { background: var(--bg-hover); color: var(--text-0); }

    /* ── Buttons ────────────────────────────────────────────────── */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 5px;
      padding: 5px 12px; border: 1px solid var(--border-mid); border-radius: var(--radius);
      font-family: inherit; font-size: 12px; cursor: pointer; background: var(--bg-3);
      color: var(--text-0); transition: background .15s; outline: none;
    }
    .btn:hover { background: var(--bg-hover); }
    .btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn-sm { padding: 4px 10px; font-size: 11px; }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; width: 100%; padding: 8px; font-size: 13px; }
    .btn-primary:hover { background: var(--accent-h); border-color: var(--accent-h); }
    .btn-primary:disabled { opacity: 0.45; cursor: not-allowed; }

    /* ── Separator ──────────────────────────────────────────────── */
    .sep { height: 1px; background: var(--border); margin: 14px 0; }

    /* ── Loading / Error ────────────────────────────────────────── */
    .loading { display: flex; align-items: center; padding: 16px 0; color: var(--text-1); font-size: 12px; }
    .spinner { width: 14px; height: 14px; border: 2px solid var(--border-mid); border-top-color: var(--accent); border-radius: 50%; animation: spin .6s linear infinite; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-box { padding: 10px; background: rgba(192,57,43,.12); border: 1px solid rgba(192,57,43,.35); border-radius: var(--radius); font-size: 12px; color: #e74c3c; line-height: 1.5; }

    /* ── Query output area ──────────────────────────────────────── */
    .explanation-box { background: var(--bg-2); border-radius: var(--radius); padding: 10px; font-size: 12px; line-height: 1.6; color: var(--text-1); margin-bottom: 12px; }

    /* ── Query variants ─────────────────────────────────────────── */
    .query-variant {
      border: 1px solid var(--border); border-radius: var(--radius);
      margin-bottom: 8px; overflow: hidden; cursor: default;
      transition: border-color .15s;
    }
    .query-variant:hover { border-color: var(--border-mid); }
    .query-variant.active { border-color: var(--accent); }

    .qv-header {
      display: flex; align-items: center; gap: 8px; padding: 8px 10px;
      background: var(--bg-2); cursor: pointer; user-select: none;
    }
    .qv-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .qv-name { flex: 1; font-size: 12px; font-weight: 600; }
    .qv-count { font-size: 11px; color: var(--text-2); }
    .qv-vis { font-size: 11px; padding: 1px 5px; border-radius: 2px; border: 1px solid var(--border-mid); color: var(--text-1); background: var(--bg-3); cursor: pointer; line-height: 1.4; }
    .qv-vis:hover { background: var(--bg-hover); }

    .qv-body { padding: 8px 10px; font-size: 12px; color: var(--text-1); line-height: 1.55; border-top: 1px solid var(--border); display: none; }
    .query-variant.active .qv-body { display: block; }

    .qv-code-toggle { background: none; border: none; color: var(--text-2); font-size: 10px; cursor: pointer; text-decoration: underline; margin-top: 6px; padding: 0; font-family: inherit; }
    .qv-code-toggle:hover { color: var(--text-1); }

    .qv-code {
      display: none; margin-top: 6px; padding: 8px; background: var(--bg-0);
      border: 1px solid var(--border); border-radius: var(--radius);
      font-size: 10.5px; font-family: 'SF Mono', 'Consolas', monospace; color: #8ab4f8;
      white-space: pre; overflow-x: auto; max-height: 180px; overflow-y: auto;
    }

    /* ── Wiki references ────────────────────────────────────────── */
    .wiki-ref { padding: 8px; background: var(--bg-2); border-radius: var(--radius); margin-bottom: 6px; border-left: 2px solid var(--accent); }
    .wiki-tag { font-size: 11px; font-weight: 700; font-family: 'SF Mono', 'Consolas', monospace; margin-bottom: 3px; }
    .wiki-tag a { color: var(--accent); text-decoration: none; }
    .wiki-tag a:hover { text-decoration: underline; }
    .wiki-desc { font-size: 11px; color: var(--text-1); line-height: 1.45; }

    /* ── Map ────────────────────────────────────────────────────── */
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }

    .map-toolbar {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      z-index: 2000; display: flex; gap: 6px;
    }
    .map-toolbar .btn { background: rgba(30,30,30,.95); }

    /* Leaflet dark overrides */
    .leaflet-control-zoom a { background: var(--bg-1) !important; color: var(--text-0) !important; border-color: var(--border) !important; }
    .leaflet-control-attribution { background: rgba(20,20,20,.8) !important; color: var(--text-2) !important; }
    .leaflet-control-attribution a { color: var(--text-1) !important; }
    .leaflet-popup-content-wrapper { background: var(--bg-1) !important; color: var(--text-0) !important; border: 1px solid var(--border-mid) !important; box-shadow: 0 3px 12px rgba(0,0,0,.6) !important; border-radius: var(--radius) !important; }
    .leaflet-popup-tip { background: var(--bg-1) !important; }
    .leaflet-popup-content { font-size: 12px; line-height: 1.5; }

    /* ── Results panel ──────────────────────────────────────────── */
    .results-list { flex: 1; overflow-y: auto; }

    .result-item {
      display: flex; align-items: stretch; gap: 0; padding: 0;
      border-bottom: 1px solid var(--border); cursor: pointer; transition: background .1s;
    }
    .result-item:hover { background: var(--bg-2); }
    .result-item.selected { background: rgba(10,132,255,.12); }

    .result-bar { width: 3px; flex-shrink: 0; }
    .result-inner { flex: 1; padding: 7px 10px; min-width: 0; }
    .result-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .result-meta { font-size: 10px; color: var(--text-2); text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px; }

    .results-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; color: var(--text-2); font-size: 12px; text-align: center; }
    .results-empty-title { font-size: 13px; font-weight: 600; color: var(--text-1); margin-bottom: 6px; }

    /* ── Status bar ─────────────────────────────────────────────── */
    .statusbar {
      height: 22px; background: var(--bg-1); border-top: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 12px; gap: 14px;
      font-size: 11px; color: var(--text-2); flex-shrink: 0;
    }
    .statusbar-spacer { flex: 1; }

    /* ── Modal ──────────────────────────────────────────────────── */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,.65);
      z-index: 9999; align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--bg-1); border: 1px solid var(--border-mid); border-radius: 4px; padding: 24px; width: 400px; }
    .modal-title { font-size: 14px; font-weight: 700; margin-bottom: 18px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 18px; }

    /* ── Scrollbar ──────────────────────────────────────────────── */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-mid); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* ── Empty state for results ────────────────────────────────── */
    .results-limit-note { padding: 8px 12px; font-size: 11px; color: var(--text-2); text-align: center; border-top: 1px solid var(--border); }

    /* ── Saved searches ──────────────────────────────────────────── */
    .saved-item {
      border: 1px solid var(--border); border-radius: var(--radius);
      margin-bottom: 6px; overflow: hidden;
    }
    .saved-item-header {
      display: flex; align-items: center; gap: 6px; padding: 6px 10px;
      background: var(--bg-2); user-select: none;
    }
    .saved-item-name { flex: 1; font-size: 11px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
    .saved-item-date { font-size: 10px; color: var(--text-2); white-space: nowrap; }
    .saved-item-btn { font-size: 10px; padding: 1px 6px; border-radius: 2px; border: 1px solid var(--border-mid); color: var(--text-1); background: var(--bg-3); cursor: pointer; line-height: 1.4; flex-shrink: 0; }
    .saved-item-btn:hover { background: var(--bg-hover); }
    .saved-item-btn.danger { border-color: var(--danger); color: var(--danger); }
    .saved-item-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .saved-item-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .saved-item-body { padding: 6px 10px; font-size: 11px; color: var(--text-1); line-height: 1.5; border-top: 1px solid var(--border); display: none; }
    .saved-item.open .saved-item-body { display: block; }
    .saved-empty { font-size: 11px; color: var(--text-2); text-align: center; padding: 8px 0; }

    /* ── Export CSV button ───────────────────────────────────────── */
    .results-header-btns { display: flex; gap: 4px; }

    /* ── Icon buttons ────────────────────────────────────────────── */
    .btn-icon { padding: 4px 8px; }
    .btn-icon i { font-size: 12px; }

    /* ── CSV Export modal ────────────────────────────────────────── */
    .csv-modal { width: 560px; max-height: 82vh; display: flex; flex-direction: column; }
    .csv-field-list { flex: 1; overflow-y: auto; margin: 0 -8px; }
    .csv-field-row {
      border-bottom: 1px solid var(--border); padding: 8px 10px;
      display: flex; flex-direction: column; gap: 4px;
    }
    .csv-field-header { display: flex; align-items: center; gap: 8px; }
    .csv-field-label { font-size: 12px; font-weight: 600; flex: 1; font-family: 'SF Mono','Consolas',monospace; }
    .csv-field-count { font-size: 10px; color: var(--text-2); }
    .csv-value-chips { display: flex; flex-wrap: wrap; gap: 4px; padding-left: 22px; }
    .csv-value-chip {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 1px 7px; border-radius: 10px; border: 1px solid var(--border-mid);
      font-size: 10px; color: var(--text-1); background: var(--bg-3); cursor: default;
      transition: background .12s;
    }
    .csv-value-chip:hover { background: rgba(10,132,255,.18); border-color: var(--accent); color: var(--text-0); }
    .csv-value-chip .chip-count { color: var(--text-2); font-size: 9px; }
    .csv-modal-footer { display: flex; align-items: center; gap: 8px; margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); }
    .csv-modal-footer .spacer { flex: 1; }

    /* ── SVG Export modal ────────────────────────────────────────── */
    .svg-modal { width: 380px; }
    .radio-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer; font-size: 12px; }
    .check-row { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; }
  </style>
</head>
<body>
<div class="app">

  <!-- Top bar -->
  <div class="topbar">
    <span class="topbar-title">Overpass AI</span>
    <span class="topbar-spacer"></span>
    <button class="btn btn-sm btn-icon" id="shareBtn" title="Copy share link to clipboard"><i class="fa-solid fa-share-nodes"></i> Share</button>
    <button class="btn btn-sm btn-icon" id="settingsBtn" title="Settings"><i class="fa-solid fa-gear"></i></button>
  </div>

  <!-- Main layout -->
  <div class="layout">

    <!-- Left: query panel -->
    <aside class="panel panel-left">
      <div class="panel-header"><span>Query</span></div>
      <div class="panel-body">

        <div class="form-group">
          <label class="label" for="questionInput">Geographic Question</label>
          <textarea id="questionInput" placeholder="e.g. What are all the chocolate stores in the Netherlands?&#10;&#10;Ctrl+Enter to generate"></textarea>
        </div>

        <div id="examplesSection">
          <div class="label">Examples</div>
          <div class="example-list" id="exampleList"></div>
        </div>

        <button class="btn btn-primary" id="generateBtn">Generate Query</button>

        <div id="loadingState" style="display:none;">
          <div class="loading"><div class="spinner"></div><span id="loadingText">Generating query...</span></div>
        </div>

        <div id="errorState" style="display:none; margin-top:12px;" class="error-box">
          <span id="errorText"></span>
        </div>

        <div id="queryOutput" style="display:none; margin-top:4px;">
          <div class="sep"></div>
          <div class="label" style="margin-bottom:6px;">Explanation</div>
          <div class="explanation-box" id="explanationBox"></div>
          <div class="label" style="margin-bottom:6px;">Query Variants</div>
          <div id="queryVariants"></div>
          <div id="wikiSection" style="display:none; margin-top:14px;">
            <div class="label" style="margin-bottom:6px;">OSM Tag References</div>
            <div id="wikiRefsList"></div>
          </div>
        </div>

        <div id="savedSection" style="margin-top:14px;">
          <div class="sep"></div>
          <div class="label" style="margin-bottom:6px;">Saved Searches</div>
          <div id="savedList"></div>
        </div>

      </div>
    </aside>

    <!-- Center: map -->
    <main class="map-container">
      <div id="map"></div>
      <div class="map-toolbar">
        <button class="btn btn-sm btn-icon" id="brushBtn" title="Brush Select"><i class="fa-solid fa-pen"></i> Brush Select</button>
        <button class="btn btn-sm btn-icon" id="clearSelBtn" title="Clear Selection"><i class="fa-solid fa-xmark"></i> Clear</button>
        <button class="btn btn-sm btn-icon" id="fitBtn" title="Fit Results to Map"><i class="fa-solid fa-expand"></i> Fit</button>
      </div>
    </main>

    <!-- Right: results panel -->
    <aside class="panel panel-right">
      <div class="panel-header">
        <span>Results</span>
        <div class="results-header-btns">
          <button class="btn btn-sm btn-icon" id="exportCsvBtn" title="Export CSV"><i class="fa-solid fa-file-csv"></i></button>
          <button class="btn btn-sm btn-icon" id="exportGpxBtn" title="Export GPX"><i class="fa-solid fa-file-export"></i></button>
          <button class="btn btn-sm btn-icon" id="exportSvgBtn" title="Export SVG"><i class="fa-regular fa-image"></i></button>
        </div>
      </div>
      <div class="results-list" id="resultsList">
        <div class="results-empty" id="resultsEmpty">
          <div class="results-empty-title">No Results</div>
          <div>Generate a query to see results here.</div>
        </div>
      </div>
    </aside>

  </div><!-- /layout -->

  <!-- Status bar -->
  <div class="statusbar">
    <span id="statusText">Ready</span>
    <span class="statusbar-spacer"></span>
    <span id="statusResults"></span>
    <span id="statusBounds"></span>
  </div>

</div><!-- /app -->

<!-- Settings modal -->
<div class="modal-overlay" id="settingsOverlay">
  <div class="modal">
    <div class="modal-title">Settings</div>
    <div class="form-group">
      <label class="label" for="apiKeyInput">OpenAI API Key</label>
      <input type="password" id="apiKeyInput" placeholder="sk-..." autocomplete="off" />
      <div class="help-text">Stored in your browser's localStorage. Never sent to any server other than api.openai.com.</div>
    </div>
    <div class="form-group">
      <label class="label" for="modelSelect">Model</label>
      <select id="modelSelect">
        <option value="gpt-4o">GPT-4o (recommended)</option>
        <option value="gpt-4-turbo">GPT-4 Turbo</option>
        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" id="cancelSettingsBtn">Cancel</button>
      <button class="btn btn-primary" id="saveSettingsBtn" style="width:auto;padding:6px 18px;">Save</button>
    </div>
  </div>
</div>

<!-- CSV Export modal -->
<div class="modal-overlay" id="csvExportOverlay">
  <div class="modal csv-modal">
    <div class="modal-title"><i class="fa-solid fa-file-csv" style="margin-right:6px;"></i>Export CSV — Select Fields</div>
    <div class="csv-field-list" id="csvFieldList"></div>
    <div class="csv-modal-footer">
      <button class="btn btn-sm" id="csvSelectAllBtn">Select All</button>
      <button class="btn btn-sm" id="csvDeselectAllBtn">Deselect All</button>
      <span class="spacer"></span>
      <button class="btn" id="cancelCsvBtn">Cancel</button>
      <button class="btn btn-primary" id="doExportCsvBtn" style="width:auto;padding:6px 18px;"><i class="fa-solid fa-download"></i> Export</button>
    </div>
  </div>
</div>

<!-- SVG Export modal -->
<div class="modal-overlay" id="svgExportOverlay">
  <div class="modal svg-modal">
    <div class="modal-title"><i class="fa-regular fa-image" style="margin-right:6px;"></i>Export SVG</div>
    <div class="form-group">
      <label class="label">Element Style</label>
      <label class="radio-row"><input type="radio" name="svgStyle" value="areas" checked /> Polygons (areas as shapes, lines as lines)</label>
      <label class="radio-row"><input type="radio" name="svgStyle" value="dots" /> Dots (force all elements as points)</label>
    </div>
    <div class="form-group">
      <label class="check-row"><input type="checkbox" id="svgTilesCheck" checked /> Include map background tiles (OpenStreetMap)</label>
    </div>
    <div class="modal-actions">
      <button class="btn" id="cancelSvgBtn">Cancel</button>
      <button class="btn btn-primary" id="doExportSvgBtn" style="width:auto;padding:6px 18px;"><i class="fa-solid fa-download"></i> Export SVG</button>
    </div>
  </div>
</div>

<script>
/* ======================================================================
   Overpass AI — main application script
   ====================================================================== */

// D3 schemeCategory10 colours (hardcoded to avoid full D3 dependency)
const COLORS = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];

// Selection highlight colour — visible on both dark and light map tiles
const SEL_COLOR = '#ffcc00';

// Minimum pixel size (max dimension) for area polygons; smaller → shown as dot
const AREA_MIN_PX = 10;

// Comprehensive OSM tag lookup table — key → array of known values currently in use
const OSM_TAG_LOOKUP = {"abandoned":["yes"],"abandoned:amenity":["prison","prison_camp"],"abandoned:landuse":["landfill"],"abandoned:place":["yes"],"access":["employees","license","members","military","optional_sidepath","residents","students"],"addr:TW:dataset":["137998"],"addr:housenumber:signed":["no"],"admin_type:PH":["barangay"],"advertising":["flag","sculpture","tarp","totem","wall_painting"],"aerialway:drag_lift":["platter","t-bar"],"aerodrome:type":["airfield","gliding","international","military","private","regional"],"aerospace:product":["robot","rocket","satellite","spacecraft","spacecraft_propulsion"],"aeroway":["airtanker_base","arresting_gear","control_center","flame_trench","landingpad","launch_complex","launchpad","model_runway","spaceport"],"aeroway:balloon":["launchpad"],"aircraft:type":["glider"],"amenity":["animal_effluent_disposal","animal_hitch","animal_training","archive","bear_box","bicycle_library","binoculars","bird_bath","blood_bank","boat_storage","brothel","building_yard","canteen","car_pooling","carpet_washing","chair","check_in","checkpoint","childcare","cloakroom","clothes_dryer","clothing_donation","coffin_rest","compressed_air","concert_hall","coworking_space","dancing_school","device_charging_station","dog_wash","dojo","dormitory","driver_training","entrenamiento","exhibition_centre","feeding_place","festival_grounds","first_aid","first_aid_school","fish_cleaning","fish_spa","flight_school","food_sharing","game_feeding","health_post","hitching_post","juice_bar","karaoke_box","kick-scooter_parking","kick-scooter_rental","kitchen","lavoir","left_luggage","locker","lost_property_office","lounge","luggage_locker","marae","meditation_centre","mist_spraying_cooler","mobile_library","mobility_hub","money_transfer","mortuary","motorcycle_rental","mounting_block","music_venue","nursing_home","nursing_room","osmica","payment_centre","planetarium","polling_station","post_depot","power_supply","practice_bicycle_carrier","printer","prison_camp","produce_collection_centre","reception_desk","rehearsal_studio","rescue_station","retirement_home","rv_storage","sailing_school","sanatorium","scale","scooter_rental","seat","security_booth","security_control","ski_rental","ski_school","small_electric_vehicle_parking","smoking_area","snow_removal_station","social_centre","social_club","stables","stage","stool","stripclub","stroller_parking","student_accommodation","surf_school","swingerclub","table","tool_library","trade_school","traffic_park","training","tuition","vacuum_cleaner","vehicle_ramp","veterinary_pharmacy","vivarium","warehouse","washing_machine","waste_basket;recycling","waste_dump_site","whirlpool","workshop"],"animal":["horse_walker","school"],"animated":["trivision_blades","winding_posters"],"app_operated":["only"],"aquaculture":["fish","seaweed"],"archaeological_site":["amphitheatre","baths","bigstone","cairn","church","city","cliff_dwelling","crannog","desert_kite","earthwork","enclosure","field_system","geoglyph","grave_field","hut_circle","necropolis","petroglyph","rock_painting","roman_circus","roman_villa","souterrain","tomb","trap_pit"],"area:highway":["cycleway","footway","path","pedestrian","steps"],"artwork_subject":["street_art"],"artwork_type":["architecture","coat_of_arms","dwarf","figurine","land_art","relief","street_art"],"asphalt:type":["dense","porous","porous:double","stone_mastic","thin_surface_layer"],"association":["sport","student"],"athletics":["discus_throw","hammer_throw","high_jump","javelin_throw","running","sprint","steeplechase","triple_jump"],"atm":["separate"],"attraction":["alpine_coaster","amusement_ride","balloon_ride","big_wheel","boat_ride","bumper_car","carousel","historic","kiddie_ride","maze","seaplane_ride","slide","summer_toboggan","teacup"],"audio_loop":["yes"],"balloon:type":["research"],"barrier":["armadillo","avalanche_protection","bar","barricade","barrier_board","berm","coupure","debris","delineator_kerb","delineators","dug-in_tyres","floating_boom","haha","horse_jump","lych_gate","parking_bumper","parking_lock","planter","sliding_beam","sliding_gate","steeplechase_jump","step","sump_buster","tank_trap","tyres","wedge","wicket_gate","yes"],"basin":["aeration","footbath","settling","water_regeneration"],"bath:type":["foot_bath","hammam","hot_spring","lake","onsen","pool","river","sea","sento","thermal"],"bay":["fjord"],"beacon:type":["DME","IM","MM","NDB","OM","TACAN","VORTAC","bluetooth"],"beauty":["spa","tanning"],"bench":["wave_lounger"],"bicycle":["dismount","optional_sidepath"],"bicycle_rental":["dropoff_point"],"board_type":["company"],"books":["comic"],"border_type":["nation"],"boules":["bocce","boule_de_fort","breton"],"boundary":["administrative_cooperation","census","civil","disputed","exclave","historic","limited_traffic_zone","local_authority","lot","low_emission_zone","marker","place","public_transport","regional_park","safety_region","statistical","timezone","urban","water_protection_area"],"brand":["Eroski","Harley-Davidson","KTM","Louis_Motorrad","Moto_Guzzi","Polo_Motorrad","Spar","Triumph","Zero"],"bridge":["log_bridge"],"bridge:movable":["retractable","submersible","tilt"],"bridge:structure":["clapper","humpback","simple-suspension"],"bridge:support":["pylon"],"building":["agricultural","barracks","bath","beach_hut","bell_tower","brewery","bridge","bus_station","carport","castle","central_office","changing_rooms","cinema","civic","clinic","convent","data_center","data_centre","demountable","digester","dog_house","dovecote","factory","font","fort","funeral_hall","garbage_shed","gatehouse","gauge_house","gazebo","ger","goat_shed","government","government_office","ground_station","guardhouse","guest_house","hall_of_residence","hostel","hotel","houseboat","kingdom_hall","kiosk","library","lighthouse","livestock","mall","marketplace","marquee","military","mink_shed","mobile_home","monastery","mortuary","museum","outbuilding","pagoda","palace","pavilion","police","porch","presbytery","prison","railway","religious","riding_hall","roundhouse","ruins","sanitary","sauna","semi","sheepfold","shepherd_shelter","ship","show_house","shrine","silo","smithy","sports_hall","stadium","sty","swimming_pool","tech_cab","tent","terraced_house","tower","townhall","transportation","tree_house","triumphal_arch","trullo","venta","villa","water_tower","wayside_shrine","wine_cellar","workshop"],"building:part":["balcony","column","porch","steps"],"building:prefabricated":["yes"],"building:use":["stable","warehouse"],"bunker_type":["bomb_shelter","gun_emplacement","hardened_aircraft_shelter","personnel_shelter","technical"],"bus":["minibus","no","school"],"busbar":["flexible","rigid"],"by_night":["only"],"cafe":["board_game","time-cafe","time_cafe","yes"],"camra":["yes"],"canoe":["portage"],"cargo":["container","liquid_bulk"],"castle_type":["castrum","kremlin","shiro"],"caterer":["dark_kitchen"],"cemetery":["cillin","war_cemetery","wood"],"channelised":["yes"],"climbing":["area","crag","route"],"clothes":["babies","children","fashion","luxury","motorcycle","sports","swimwear","unisex","vintage","wedding","women","women;men","women;men;children","workwear"],"club":["art","automobile","baduk","bicycle","board_games","card_games","chess","computer","fan","fishing","freemasonry","golf","hunting","linux","model_railway","motorcycle","music","nudism","sailing","scuba_diving","social","student","tourism","veterans","youth","youth_movement"],"coastline":["bogus"],"coastline:survey_quality":["complete"],"collection_times:signed":["no"],"commons":["lets"],"community_centre":["club_home","community_hall","family_centre","meeting_room"],"community_centre:for":["entrepreneur"],"company":["aerospace","agrarian","balloon","construction","distribution","internet_shop","it","logistics","robot","software","software_development","transport"],"compensator":["petersen_coil","voltage_regulator"],"construction":["minor","office"],"consulate":["residence"],"content":["hot_water","rainwater"],"cooling:method":["air_cooling","dry_cooling","mechanical_draft","natural_draft"],"craft":["agricultural_engines","atelier","bag_repair","bakery","basket_maker","beekeeper","boatbuilder","bookbinder","builder","cabinet_maker","candlemaker","car_painter","carpet_cleaner","carpet_layer","cheese","chimney_sweeper","cleaning","clockmaker","confectionery","cooper","dental_technician","distillery","door_construction","dressmaker","elevator","embroiderer","engraver","excavation","fence_maker","floorer","glassblower","goldsmith","gunsmith","hvac","insulation","interior_decorator","interior_work","jeweller","key_cutter","laboratory","lapidary","leather","locksmith","luthier","mint","musical_instrument","oil_mill","optician","organ_builder","parquet_layer","paver","pest_control","photographic_laboratory","photovoltaic","piano_tuner","plasterer","printer","printmaker","restoration","rigger","roofer","saddler","sailmaker","scaffolder","sculptor","signmaker","stand_builder","stove_fitter","sun_protection","tatami","tiler","tinsmith","toolmaker","turner","watchmaker","water_well_drilling","weaver","welder"],"crane:type":["floor-mounted_crane","gantry_crane","portal_crane","tower_crane","travel_lift"],"crematorium":["pet"],"crop":["asparagus","barley","cassava","cereal","coffee","fast_growing_wood","flowers","grape","grass","hay","hop","maize","oats","rape","rye","strawberry","sunflower","tea","wheat"],"crossing":["informal"],"cuisine":["acai","bagel","barbecue","beef_bowl","brazilian","bubble_tea","cake","couscous","crepe","curry","dessert","dim_sum","donut","dumpling","dumplings","empanada","friture","frozen_yogurt","grill","gyros","hot_dog","hot_pot","hotpot","jause","kebab","noodle","palestinian","pancake","pasta","pastry","pie_and_mash","ramen","rice_noodle","sausage","soup","steak","strudel","surinamese","syrian","tapas","tea","tea_shop","teahouse","tex-mex","ukrainian","vietnamese","waffle","wings"],"culvert":["arch","inverted_siphon"],"cycle_network":["BE-BRU:cycle_highway","BE-VLG:cycle_highway","DE:BW:RadNETZ","DE:HH:Radnetz_Hamburg","JP:prefectural","US","US:CA:SF","US:US","US:USA"],"cycleway":["link","share_busway","sidepath","sidewalk"],"cycleway:foot":["designated","no"],"cycleway:left:oneway":["no"],"cycleway:right:oneway":["no","yes"],"cycling":["pump_track"],"damage:event":["war"],"damage:type":["explosion"],"defensive":["bergfried","donjon"],"delivery":["shipment"],"dennert_fir_tree":["yes"],"denomination":["iglesia_filipina_independiente","jehovahs_witness","jodo_shinshu","jodo_shu","la_luz_del_mundo","mormon","nichiren","reformed","shingon_shu","soto","tiantai","ukrainian_orthodox"],"denotation":["windbreak"],"designation":["bathing_water","byway_open_to_all_traffic","civil_parish","common","core_path","public_bridleway","public_footpath","quiet_lane","restricted_byway","shared_path"],"diet:kosher":["only","yes"],"diet:meat":["yes"],"disused:amenity":["fountain"],"disused:landuse":["landfill","quarry"],"dock":["drydock","floating"],"dog":["designated","outside","unleashed","yes"],"door":["no"],"drink":["beer"],"dual_carriageway":["no"],"education":["exercise_area"],"electronics_repair":["phone"],"embankment":["dyke"],"emergency":["access_point","control_centre","disaster_help_point","fire_equipment","fire_flapper","fire_hose","fire_water_pond","first_aid","first_aid_kit","helisign","key_depot","ladder_site","landing_site","life_ring","marine_refuge","mountain_rescue","rescue_box","rescue_buoy","slipway","suction_point","throw_bag"],"enforcement":["average_speed","maxspeed"],"entrance":["cellar","entrance","no","secondary"],"faculty":["engineering"],"fast_food":["cafeteria"],"fence_type":["wood_bollard"],"fire_path":["yes"],"fitness_station":["horizontal_bar","sit-up","stepper"],"fixme":["name","position_estimated","verify_name"],"flag:type":["advertising","athletic"],"flood_mark":["painting","plaque"],"flood_prone":["yes"],"foot":["destination"],"footway":["alley","link","path","residential","service"],"fortification_type":["dun","limes","motte","ring_ditch","sconce"],"fountain":["bottle_refill","bubbler","decorative","drinking","roman_wolf","splash_pad","stone_block","toret","viktorija_zdenac","wallace"],"generator:source":["battery","electricity"],"generator:type":["PWR","boiler","cross-flow_turbine","francis_turbine","heat_pump","hydrodynamic_screw","kaplan_turbine","lithium_ion","pelton_turbine","steam_generator","water_wheel"],"genus":["Acer","Platanus","Quercus","Tilia"],"genus:de":["Linde"],"geological":["columnar_jointing","cone","dyke","fault","fold","giants_kettle","glacial_erratic","hoodoo","inselberg","limestone_pavement","meteor_crater","monocline","moraine","outcrop","pingo","rock_glacier","sinkhole","tor","unconformity","volcanic_caldera_rim","volcanic_lava_field","volcanic_lava_flow","volcanic_lava_tube","volcanic_vent"],"glacier:type":["mountain","rock"],"golf":["cartpath","penalty_area"],"golf:course":["driving_range","pitch_and_putt"],"government":["aerospace","archive","audit","bailiff","border_control","building_control","cadaster","chamber_of_commerce","culture","customs","data_protection","education","emergency","healthcare","heritage","it","justice","legislative","parliament","social_security","social_services","statistics","watercourse_management","youth_welfare_department"],"guest_house":["agritourism","albergue","bed_and_breakfast","student_accommodation"],"harassment_prevention":["ask_angela"],"hazard":["archery_range","avalanche","biohazard","cliff","collapse","damaged_road","electricity","emergency_vehicles","falling_trees","flooding","fog","frail_pedestrians","ground_clearance","hole","illegal_crossing","isolated_road_extreme_weather","leeches","pedestrian_crossing","road_narrows","roadworks","roundabout","steam","tide","traffic_signals","washout"],"hazard_prone":["yes"],"hazmat:water":["permissive"],"health_facility:type":["office"],"healthcare":["birthing_centre","centre","community_health_worker","counselling","dialysis","health_post","hospice","nurse","nutrition_counselling","pharmacy","rehabilitation","yes"],"healthcare:speciality":["equine-assisted","family_planning","implantology","rehabilitation","urgent"],"hedge":["hedge_bank"],"heritage:operator":["kons","mhs","nrhp"],"highway":["no","piste","priority","proposed","speed_display","traffic_mirror","traffic_sign","turntable","via_ferrata"],"historic":["anchor","aqueduct","bullaun_stone","cannon","caravanserai","castle_wall","cattle_crush","cemetery","epigraph","farm","flood_mark","folly","gallows","heritage","high_cross","highwater_mark","hollow_way","house","lavoir","lime_kiln","locomotive","market_cross","martello_tower","mass_path","mine_adit","missile","monastery","mosque","optical_telegraph","pillory","police_call_box","pound","railway","railway_car","railway_station","rampart","road","round_tower","ruins","rune_stone","shieling","ship","smithy","stecak","tank","temple","tower","tree_shrine","vehicle","warehouse","watermill"],"horse":["dismount"],"house":["bungalow","detached","link-detached","maisonette","semi-detached","terrace","terraced"],"hov":["yes"],"ice_skates":["kluning"],"indoor":["area","column","corridor","door","room","wall","yes"],"industrial":["aerospace","aluminium_smelting","asphalt_plant","auto_wrecker","automotive_parts","bakery","brewery","communication","concrete_plant","construction_company","data_centre","distributor","electrical","furniture","gas_plant","gas_storage","grinding_mill","heating_station","ice_factory","logistics","machine_shop","metal_processing","mine","oil_mill","petroleum_terminal","plastic_processing","port","recycling","refinery","refrigerated_warehouse","rice_mill","sawmill","shipyard","slaughterhouse","steel_mill","storage","trucking"],"informal":["no"],"information":["audioguide","helpdesk","post","route_marker","sign","stele","tactile_map","tactile_model","trail_blaze","visitor_centre"],"insurance":["health"],"irrigation":["yes"],"junction":["controlled","jughandle","spui","uncontrolled"],"landcover":["flowerbed","grass","gravel","greenery","mostly_rock","trees"],"landform":["dune_system"],"landuse":["animal_keeping","apiary","canal","civic_admin","culture","fairground","forestry","governmental","greenery","harbour","healthcare","highway","horticulture","institutional","logging","paddy","peat_cutting","recreation_ground","reservoir_watershed","static_caravan","traffic_island","tree_pit","winter_sports"],"lawyer":["bailiff","notary"],"leaf_type":["palm"],"leisure":["axe_throwing","barefoot","bathing_place","batting_cage","beach","bingo_hall","climbing","common","festival_grounds","fox_covert","hammock","high_ropes_course","hot_tub","indoor_play","music_venue","paddling_pool","parklet","practice_pitch","rage_room","recreation_ground","schoolyard","shooting_ground","soccer_golf","social_club","summer_camp","sunbathing","swimming_platform","tanning_salon","trampoline_park","village_swing","wellness","wildlife_hide"],"level_crossing":["uncontrolled"],"line":["substation"],"location":["cave","indoor","outdoor","overhead","platform","rooftop"],"lottery":["yes"],"maintenance":["gritting"],"man_made":["advertising","aircraft","animal_ramp","animal_trap","archimedes_screw","avalanche_protection","basin","beach_pole","beacon","bell","bioswale","bird_feeder","birdhouse","borehole","cellar_entrance","chiller","clarifier","clothes_line","column","compass_rose","composting_plant","compressor","cooling_tower","courtyard","crane_rail","culvert","desalination_plant","dovecote","drinking_fountain","duck_decoy","eruv_lechi","eruv_string","excavation","ferry_cable","flare","floating_storage","flowerbed","foundation","frost_fan","fuel_column","fuel_pump","gas_dehydrator","grave","guy_wire","heap","insect_hotel","lamp","maypole","milk_churn_stand","mountaineers_mailbox","offshore_platform","oil_gas_separator","outfall","oxidation_ditch","pavement_light","planter","platform","process_tank","quay","reinforced_slope","ruins","satellite_dish","school_sentry","septic_tank","sewer_vent","sheepfold","sign","ski_jump","slurry_basin","slurry_tank","snow_cannon","soccer_goal","spring_box","stele","stecak","telephone_box","tell","threshing_floor","tomb","tunnel","urine_deflector","warehouse","wildlife_crossing","windpump"],"manhole":["drain","sewer","telecom"],"map_type":["scheme","street","topo","toposcope"],"marker":["borderpole","borderstone","paddle"],"material":["tufa"],"maxheight":["default"],"maxspeed":["implicit","none"],"maxspeed:type":["AU:rural","AU:urban","CA-AB:rural","CA-AB:urban","CA-ON:rural","CA-ON:urban","CA:urban","GB:motorway","GB:nsl_dual","GB:nsl_restricted","GB:nsl_single","GB:zone20","GB:zone40","NL:living_street","NL:motorroad","NL:motorway","NL:rural","NL:urban","PL:rural","PL:urban"],"meadow":["paddock","pasture"],"medical_system:western":["yes"],"megalith_type":["alignment","chamber","cist","gallery_grave","long_barrow","nuraghe","passage_grave","ring_cairn","round_barrow","stone_circle","stone_ship","tholos","well"],"memorial":["bench","cenotaph","ghost_bike","immortality_tower","peace_pole","stolperschwelle","storm_surge_post","vehicle"],"message":["funding"],"military":["academy","ammunition","barracks","checkpoint","depot","launchpad","nuclear_explosion_site","obstacle_course","office","school","training_area","trench"],"monument":["statue"],"mooring":["commercial","cruise","ferry","guest"],"mtb:type":["downhill"],"museum":["aerospace","agriculture","archaeological","art","automobile","aviation","children","history","local","military","motorcycle","natural_history","nature","open_air","person","railway","science","technology","transport"],"name:signed":["no"],"natural":["anthill","arch","atoll","bare_ground","beaver_dam","birds_nest","blockfield","blowhole","crevasse","desert","dune","esker","flowers","geothermal","geothermal_area","geothermal_field","gorge","grass","gully","hill","landform","landslide","massif","mountain_range","mud","plant","shrub","shrubbery","termite_mound","tree_group","tundra","wallow"],"navigationaid":["reil","rel","rgl","rwc","rwe","rwt","tdz","txc","txe","vasi"],"network":["AuenBlicke","CA:ON:York","Flinkster","JP:national","JP:prefectural","KR:national","MA:A","MA:RN","MA:RP","MA:RR","NL:A","NL:N","NL:R:IJmuiden","NL:R:Ommen","NL:R:Schouwen","NL:R:Sluis","NL:R:Spaarnwoude","NL:R:Voorthuizen","NL:S:Amsterdam","NL:S:Den_Haag","NL:S:Heerlen","NL:S:Nijmegen","NL:S:Parkstad","NL:S:Rotterdam","NL:S:Zaanstad","NL:binnenstedelijke_ring","NL:ring","SE:LS","SE:LV","SE:RV","US:ADHS","US:KY:AA","US:KY:Parkway","US:MD","US:NY:Orange","US:NY:Parkway","US:NY:Parkway:LI","US:NY:Parkway:NYC","US:OH:CAR","US:PIPC","US:TX:Van_Zandt","US:TX:Wood","US:US:Historic","US:WV","US:WV:HARP","US:WV:Mason","US:WV:McDowell","US:WV:Mercer","VE:R:PO","cambio_stadtmobil","e-road","e-waterway","lhn","lpn","rhn","rin","rmn","rpn"],"nobrand":["yes"],"noname":["no"],"nonsquare":["yes"],"observatory:type":["astronomical","gravitational","meteorological"],"obstacle:wheelchair":["yes"],"office":["accountant","advertising_agency","airline","architect","archive","bail_bond_agent","call_centre","camping","chamber","charity","construction_company","consulting","cooperative","courier","coworking","engineer","event_management","forestry","foundation","geodesist","gongo","graphic_design","guide","harbour_master","healthcare","highway","information","insurance_adjuster","interior_design","international_organization","it","logistics","lost_property","medical","moving_company","natural_gas_utility","newspaper","ngo","notary","parish","personal_service","pest_control","politician","private_investigator","property_management","publisher","quango","reception","rental","research","school","security","surveyor","tax_advisor","telecommunication","therapist","translator","transport","travel_agent","tutoring","union","university","visa","wedding_planner","yes"],"on_demand":["yes"],"oneway:bus":["no"],"oneway:motorcycle":["no"],"oneway:psv":["no"],"opening_hours":["closed"],"operator":["Agentschap_voor_Natuur_en_Bos","Bundesrepublik_Deutschland","Flinkster","GRDF","Havenbedrijf_Rotterdam_N.V.","Koninkrijk_der_Nederlanden","La_Banque_Postale","La_Poste","Land_Aruba","Land_Curacao","Land_Sint_Maarten","Staat_der_Nederlanden","WOSM","book-n-drive","independent","teilAuto"],"organ":["yes"],"outdoor_seating":["patio","terrace"],"owner":["Staat_der_Nederlanden"],"ownership":["community"],"park_ride":["hov"],"parking_space":["bus","charging","parent","pregnant","veteran"],"passenger":["suburban","yes"],"path":["climbing_access","crossing","desire","link","mtb","sidewalk","trail"],"pharmacy":["yes"],"physically_present":["no"],"piste:takeoff":["yes"],"piste:type":["fatbike","hike","ice_skate","ski_jump","sled","sleigh","snowmobile"],"place":["allotments","borough","city_block","continent","county","district","farm","municipality","plot","polder","province","region","sea","state","subcounty","subdistrict"],"place_of_worship":["chapel","lourdes_grotto","musalla","sacred_tree"],"placement":["right_of:1","transition"],"plant:method":["barrage","gasification","stream"],"plant:source":["battery","diesel","flywheel","tidal"],"plant:type":["boiler","gas_turbine","lithium_ion","reciprocating_engine","steam_turbine"],"playground":["baby_swing","basketswing","bridge","climbingwall","funnel_ball","horizontal_bar","map","maze","rope_swing","sledding","swing","tire_swing","tunnel_tube","youth_bench"],"pole":["flag","totem","traffic_sign"],"police":["academy","helicopter_unit"],"political_division":["NL:kamerkieskring","NL:statenkieskring","TR:TBMM","congressional_district","euro_const","linguistic_community"],"port":["cargo","fishing","roro"],"power":["insulator","inverter","outlet","terminal"],"prison_camp":["concentration_camp"],"private":["employees","exceptional_permit","members","military","residents","students"],"product":["beer","bricks","concrete","electronics","food","furniture","machinery","packaging","rice","steel","sugar"],"protect_class":["21","22"],"protected_area":["conservation","recreation","wildlife"],"protection_title":["Bien_integrante_del_patrimonio_cultural_de_Castilla-La_Mancha"],"public_transport":["entrance","fare_zone","platform_edge","platform_section_sign","pole"],"railway":["border","crossing_box","crossing_controller","derail","hirail_access","hump_yard","junction","museum","owner_change","platform_edge","platform_marker","platform_section","preserved","rail_brake","razed","roundhouse","service_station","spur_junction","tram_level_crossing","traverser","ventilation_shaft","wash","water_crane","water_tower","workshop","yard"],"railway:electricity":["joint","power_supply"],"railway:electricity:jumpering":["bridged","closed","no","possible"],"railway:radio":["gsm-r"],"railway:signal:distant:states":["FR:(A)","FR:(R)","FR:(R)+(A)","FR:(R)+A","FR:A","FR:D","FR:R","FR:R+(A)","FR:R+A","FR:VL"],"railway:signal:main:states":["FR:(A)","FR:(R)","FR:(R)+(A)","FR:(R)+A","FR:A","FR:R","FR:R+(A)","FR:R+A","FR:VL"],"railway:signal_box":["track_diagram"],"reclaimed":["yes"],"recreation_ground":["showground"],"religion":["pagan"],"removed:power":["line"],"rental":["boat","book","clothes","event","ski","skip","trailer"],"repair":["assisted_self_service","yes"],"request_stop":["yes"],"research":["aerospace"],"residential":["block","detached","duplex","halting_site","irregular_settlement","single_family","terrace","trailer_park","university"],"resource":["aggregate","coal","gravel","sand"],"restriction":["no_entry","no_exit","no_right_turn_on_red"],"restriction:bicycle":["stop"],"roller_coaster":["station","support"],"roof:shape":["apse_gabled","equal_mansard","half-dome","half-hipped","hipped-and-gabled","many","parabolic","saltbox"],"room":["classroom"],"roundabout":["turbo"],"route":["atv","canoe","detour","emergency_access","fitness_trail","historic","horse","inline_skates","light_rail","monorail","motorboat","pipeline","portage","railway","running","share_taxi","ski","snowmobile","tracks","train","transhumance","trolleybus","via_ferrata","waterway","wheelchair"],"rugby":["union","walking"],"ruins":["temple"],"school:gender":["female","male","mixed","separated"],"seamark:beacon_lateral:category":["preferred_channel_port","preferred_channel_starboard"],"seamark:buoy_lateral:colour":["green","red"],"seamark:buoy_lateral:shape":["conical"],"seamark:cable_overhead:category":["power","transmission"],"seamark:cable_submarine:category":["power"],"seamark:distance_mark:units":["hectometres","kilometres"],"seamark:harbour:category":["fishing"],"seamark:light:category":["floodlight"],"seamark:notice:category":["ferry_independent","ferry_non_independent"],"seamark:sea_area:category":["narrows","shoal"],"seamark:signal_station_traffic:category":["lock"],"seamark:small_craft_facility:category":["boat_hoist","boatyard","chandler","fuel_station","launderette","nautical_club","pump-out","showers","slipway","toilets","visitor_berth"],"seamark:type":["beacon_safe_water","berth","bunker_station","buoy_installation","buoy_isolated_danger","buoy_safe_water","cable_area","cable_overhead","cable_submarine","calling-in_point","causeway","checkpoint","coastguard_station","communication_area","dredged_area","dry_dock","dumping_ground","exceptional_structure","fairway","harbour","hulk","light","lock_basin","obstruction","pile","pipeline_submarine","platform","radar_reflector","radar_station","radio_station","sea_area","seaplane_landing_area","separation_boundary","separation_lane","separation_line","separation_zone","signal_station_traffic","signal_station_warning","virtual_aton","waterway_gauge","wreck"],"seamark:wreck:category":["dangerous","hull_showing","non-dangerous"],"service":["aircraft_control","fuel","irrigation","slipway"],"sett:style":["portuguese"],"shelter_type":["Wetterpilz","bomb_shelter","changing_rooms","field_shelter","pergola","public_transport","rock_shelter","sun_shelter","wetterpilz"],"shop":["3d_printing","atv","baking_supplies","balloon","bbq","beekeeping","boat","boat_parts","boat_repair","brewing_supplies","building_materials","business_machines","calendar","camera","camp","candles","canoe_hire","catalogue","chandler","christmas","cleaning_supplies","collector","condo","dentures","doormat","doors","eggs","energy","equestrian","esoteric","fan","fashion","flooring","food","frame","free_flying","frozen_food","fuel","gaming_machines","garden_furniture","garden_machinery","glaziery","gold_buyer","golf","golf_cart","grinding_mill","grocery","groundskeeping","growshop","haberdashery","hairdresser_supply","headshop","health_food","herbalist","honey","hookah","household_linen","hunting","hvac","hydroponics","ice_cream","insurance","jetski","junk_yard","kitchenware","knives","leatherworking","lighting","magic","maps","military_surplus","mobile_home","mobile_phone_accessories","mobility_scooter","model","money_lender","motorcycle_parts","motorsports","new_age","no","nuts","outpost","packaging","pasta","peanut_butter","pest_control","photo_studio","plant_hire","power_tools","printer_ink","printing","promotional_products","psychic","pyrotechnics","radiotechnics","religion","rental","repair","rice","robot","rope","safety_equipment","sauna","scooter","security","sewing","shed","ship_chandler","shopping_centre","skate","ski","smartshop","snack","spare_parts","spices","stairs","sunglasses","surf","tailor","telecommunication","tiles","tool_hire","tools","tractor","trailer","trophy","truck","truck_repair","vacant","video_restore","wallpaper","water","water_sports","weapons","weaver","weighing_scales","wellness","wigs","window_blind","window_tinting","windows","wool","yes"],"signpost":["forestry_compartment"],"site":["piste","planet_trail","venue","wind_farm"],"social_facility":["clothing_bank","dairy_kitchen","equine_assisted_centre","hospice"],"source":["Bing","Google","HiRes_aerial_imagery","Mapillary","NAIP","bing","mapillary","survey"],"source:ele":["AMS","SRTM","barometric"],"source:height":["estimated","estimation_levels","lidar","satellite_imagery","shadow","survey"],"source:maxspeed":["AT:city_limit30","RU:urban","implicit"],"source:name":["GNS"],"species":["Acer_platanoides","Quercus_robur","Tilia_cordata"],"sport":["8pin","9pin","aerobics","aikido","american_handball","axe_throwing","balle_pelote","bandy","barre","batting_cage","beachhandball","beachtennis","biathlon","billiards","bobsleigh","bodybuilding","bullfighting","calisthenics","canadian_football","canoe","canoe_polo","cliff_diving","climbing_adventure","cockfighting","cricket_nets","croquet","crossfit","curling","cycle_ball","cycle_polo","dance","darts","disc_golf","diving","dodgeball","dog_agility","dog_racing","fencing","fistball","five-a-side","floorball","four_square","gaga","gateball","gliding","hapkido","hiking","hopscotch","ice_stock","jetsprint","judo","karate","kick_scooter","kickball","kickboxing","kitesurfing","korfball","krachtbal","lacrosse","laser_tag","long_jump","longbowl","martial_arts","mind_body_interventions","miniature_golf","mtb","nine_mens_morris","obstacle_course","orienteering","paddle_tennis","paddleball","paddleboard","parachuting","parkour","pelota","pesapallo","pickleball","pilates","pole_dance","polo","powerlifting","racquet","rodeo","roller_hockey","roller_skating","rowing","rugby","rugby_league","rugby_union","running","russian_skittles","sailing","shot-put","shuffleboard","ski_jumping","skiing","snooker","snorkeling","speedway","squash","streetball","sumo","surfing","table_soccer","taekwondo","tamburello","teqball","tetherball","toboggan","touch_football","trampoline","trugo","ultimate","ultralight_aviation","wakeboarding","walking","water_polo","water_ski","water_sports","weightlifting","windsurfing","wrestling"],"spring:type":["hot"],"state":["alternate"],"station":["funicular"],"statue":["animal","buddha","equestrian","virgin"],"stecak":["nishan_necropolis","stecak_necropolis"],"street_cabinet":["postal_service"],"street_vendor":["yes"],"studio":["audio","television","video"],"submarine":["yes"],"subsea":["bank"],"substation":["generation"],"summit:cross":["yes"],"surface":["acrylic","bitmac","carpet","chipseal","decoturf","earth","fibre_reinforced_polymer_grate","glass","hard","hard_court","linoleum","paving_stones:lanes","plastic","sandstone","shells","snow","soil","tarmac","tiles"],"surveillance:type":["gunshot_detector"],"swimming_pool":["yes"],"symbol":["Knafelceva_markacija"],"tactile_paving":["partial"],"tank_trap":["czech_hedgehog"],"taxi_vehicle":["motorcycle"],"taxon":["Arecaceae","Eucalypteae"],"taxon:family":["Arecaceae"],"telecom":["cross-connect","data_center","line","remote_terminal"],"telescope:type":["optical","radio"],"temporary":["yes"],"theatre:genre":["philharmonic"],"theatre:type":["amphi","concert_hall","open_air","opera_house"],"theme":["cat","irish"],"tickets:public_transport":["yes"],"tickets:public_transport_subscription":["yes"],"toilets:wash":["no","shower","water_dipper"],"tomb":["table","turbe"],"tourism":["hunting_lodge","spa_resort","trail_riding_rest","trail_riding_station","wine_cellar","yes"],"tower:construction":["guyed_lattice","guyed_tube"],"tower:type":["anchor","bridge","church","diving","firefighter_training","hose","intake","launch_tower","lightning_protection","lightning_rod","minaret","monitoring","monument","popinjay","siren","water_tower"],"townhall:type":["barangay","village"],"trade":["agricultural_supplies","building_supplies","lumber","metal","timber"],"traffic_calming":["double_dip","markings","painted_island","painted_table"],"traffic_sign":["AT:52.1","AT:52.17a-a","AT:53.26a","AT:53.9c","AT:FKV_1.9","AT:WVO_F.1","DE:105-10","DE:105-20","DE:255","DE:274.1","DE:274.1-20","DE:350","DE:350-10","DE:350-20","DE:350-40","DE:386.3","DE:437","FR:B22a","FR:C113","FR:C115","GB:610","PL:A-1","PL:A-2","PL:D-42","PL:D-43","US:D3-1","US:R1-1","US:R1-1;US:R1-3P","US:R1-1;US:W4-4P","US:R1-2","US:R4-7","US:R5-1","US:R5-1a","US:R6-2R","US:S1-1","US:S1-1;US:W16-7PL","US:W1-7","US:W10-1","US:W10-1,US:W10-9P","US:W10-5,US:W10-5P","US:W11-2","US:W11-3","US:W12-2","US:W12-2a","US:W14-1","US:W14-2","US:W3-1","US:W3-3","city_limit","speedometer_test"],"traffic_signals":["blinker","continuous_green","emergency","ramp_meter","tram_priority"],"training":["art","aviation","computer","driving","language","music","sport"],"transformer":["current","potential"],"trees":["almond_trees","banana_plants","blueberry_plants","cacao_trees","coconut_palms","coffea_plants","date_palms","durian_trees","hop_plants","mango_trees","oil_palms","orange_trees","papaya_trees","pineapple_plants","rubber_trees","tea_plants"],"tunnel":["canal"],"two_sided":["yes"],"usage":["irrigation","leisure","link","military","science","test","transportation"],"utility":["eruv","loudspeaker"],"valley":["balka"],"vehicle":["agricultural;forestry"],"vending":["SIM_cards","admission_tickets","animal_feed","art","bicycle_tube","books","bottle_return","bread","candles","chemist","chewing_gums","coffee","coin_rolls","contact_lenses","e-cigarettes","eggs","electronics","elongated_coin","feminine_hygiene","first_aid","fishing_bait","fishing_tackle","flowers","food","fuel","gas","honey","ice_cream","ice_cubes","ink_cartridges","laundry_detergent","lottery","milk","movies","newspapers","pet_food","pizza","public_transport_plans","raw_milk","rice_polishing","sex_toys","sweets","syringes","telephone_vouchers","toll","toys","umbrellas","water"],"vending_machine":["fuel"],"via_ferrata":["start"],"viewpoint":["birdwatching"],"volcano:status":["active","dormant"],"volcano:type":["caldera","lava_dome","maar","scoria","shield","stratovolcano"],"voltage":["0"],"wall":["no","pise","seawall","stone_wall","tire_barrier","yes"],"waste":["ash","cigarettes","drugs","flags","oil","organic","pizza_box","recycling","rubble","trash"],"water":["fish_pass","fishpond","harbour","kolk","mere","moat","rapids","stream_pool"],"water_source":["tube_well","water_works"],"water_works":["desalination"],"waterway":["access_point","boat_lift","boatyard","canoe_pass","confluence","debris_screen","derelict_canal","drainage_channel","drystream","fairway","floating_barrier","floodgate","flow_control","flowline","fuel","link","sanitary_dump_station","security_lock","stream_end","turning_point","water_point"],"wetland":["dambo","mud"],"worship":["stations_of_the_cross"],"zone":["parking"],"zone:traffic":["DE:motorway"],"zoo":["aviary","birds","butterfly","enclosure","falconry","reptile","safari_park","wildlife_park"]};

// Layer style constants
const STYLE = {
  NODE_RADIUS:      6,
  NODE_RADIUS_SEL:  8,
  NODE_WEIGHT:      1.5,
  NODE_WEIGHT_SEL:  2.5,
  NODE_WEIGHT_HL:   2.5,
  LINE_WEIGHT:      3,
  LINE_WEIGHT_SEL:  4,
  LINE_WEIGHT_HL:   4.5,
};

const EXAMPLES = [
  'Streets where cars are allowed 50 km/h and are less than 1 km from an elementary school with pedestrian crossings',
  'Streets with shared transport of bikes and cars where the maximum speed is 50 km/h or more',
  'All chocolate stores in the Netherlands',
  'Railway stations that do not have an OV-fiets within 1 km',
];

/* ── State ──────────────────────────────────────────────────────── */
const S = {
  apiKey: '',
  model: 'gpt-4o',
  map: null,
  queries: [],      // [{name, description, overpassQL, tags, elements, layerGroup, elementLayers, areaFallbacks, visible}]
  selectedIds: new Set(),
  brush: { active: false, start: null, overlayEl: null, rectLayer: null },
  savedSearches: [], // [{id, question, queries:[{..., cachedElements}], savedAt, hidden}]
  shownSearches: {}, // id → { layerGroups: L.LayerGroup[], areaFallbacks: [] }
  currentQuestion: '',
};

/* ── Init ───────────────────────────────────────────────────────── */
function init() {
  S.apiKey = localStorage.getItem('openai_api_key') || '';
  S.model  = localStorage.getItem('openai_model')   || 'gpt-4o';
  try { S.savedSearches = JSON.parse(localStorage.getItem('saved_searches') || '[]'); } catch(e) { S.savedSearches = []; console.warn('Could not parse saved searches from localStorage:', e); }
  buildExamples();
  bindEvents();
  try {
    initMap();
    updateStatusBounds();
  } catch (e) {
    console.error('Map init failed:', e);
    setStatus('Map unavailable — check network');
  }
  renderSavedSearches();
  loadShare();
}

function initMap() {
  S.map = L.map('map', { center: [52.3676, 4.9041], zoom: 13 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19,
  }).addTo(S.map);
  S.map.on('moveend zoomend', updateStatusBounds);
  S.map.on('zoomend', updateAreaDots);
}

function buildExamples() {
  const list = document.getElementById('exampleList');
  EXAMPLES.forEach(ex => {
    const btn = document.createElement('button');
    btn.className = 'example-btn';
    btn.textContent = ex;
    btn.addEventListener('click', () => {
      document.getElementById('questionInput').value = ex;
    });
    list.appendChild(btn);
  });
}

function bindEvents() {
  // Settings
  document.getElementById('settingsBtn').addEventListener('click', openSettings);
  document.getElementById('cancelSettingsBtn').addEventListener('click', closeSettings);
  document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
  document.getElementById('settingsOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeSettings(); });

  // Query
  document.getElementById('generateBtn').addEventListener('click', handleGenerate);
  document.getElementById('questionInput').addEventListener('keydown', e => { if (e.ctrlKey && e.key === 'Enter') handleGenerate(); });

  // Map toolbar
  document.getElementById('brushBtn').addEventListener('click', toggleBrush);
  document.getElementById('clearSelBtn').addEventListener('click', clearSelection);
  document.getElementById('fitBtn').addEventListener('click', fitResults);

  // Export
  document.getElementById('exportGpxBtn').addEventListener('click', exportGPX);
  document.getElementById('exportCsvBtn').addEventListener('click', openCsvExport);
  document.getElementById('exportSvgBtn').addEventListener('click', openSvgExport);

  // CSV Export modal
  document.getElementById('cancelCsvBtn').addEventListener('click', () => document.getElementById('csvExportOverlay').classList.remove('open'));
  document.getElementById('csvExportOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) e.target.classList.remove('open'); });
  document.getElementById('csvSelectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('#csvFieldList input[type="checkbox"]').forEach(cb => cb.checked = true);
  });
  document.getElementById('csvDeselectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('#csvFieldList input[type="checkbox"]').forEach(cb => cb.checked = false);
  });
  document.getElementById('doExportCsvBtn').addEventListener('click', doExportCsv);

  // SVG Export modal
  document.getElementById('cancelSvgBtn').addEventListener('click', () => document.getElementById('svgExportOverlay').classList.remove('open'));
  document.getElementById('svgExportOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) e.target.classList.remove('open'); });
  document.getElementById('doExportSvgBtn').addEventListener('click', doExportSvg);

  // Share
  document.getElementById('shareBtn').addEventListener('click', shareQuery);
}

/* ── Settings ───────────────────────────────────────────────────── */
function openSettings() {
  document.getElementById('apiKeyInput').value = S.apiKey;
  document.getElementById('modelSelect').value = S.model;
  document.getElementById('settingsOverlay').classList.add('open');
}
function closeSettings() { document.getElementById('settingsOverlay').classList.remove('open'); }
function saveSettings() {
  S.apiKey = document.getElementById('apiKeyInput').value.trim();
  S.model  = document.getElementById('modelSelect').value;
  localStorage.setItem('openai_api_key', S.apiKey);
  localStorage.setItem('openai_model',   S.model);
  closeSettings();
}

/* ── Status bar ─────────────────────────────────────────────────── */
function setStatus(msg) { document.getElementById('statusText').textContent = msg; }
function updateStatusBounds() {
  if (!S.map) return;
  const b = S.map.getBounds();
  document.getElementById('statusBounds').textContent =
    `${b.getSouth().toFixed(4)}, ${b.getWest().toFixed(4)} — ${b.getNorth().toFixed(4)}, ${b.getEast().toFixed(4)}`;
}
function updateStatusResults() {
  const total = S.queries.reduce((n, q) => n + (q.elements ? q.elements.length : 0), 0);
  const sel   = S.selectedIds.size;
  document.getElementById('statusResults').textContent =
    total ? `${total} result${total !== 1 ? 's' : ''}${sel ? `, ${sel} selected` : ''}` : '';
}

/* ── Generate ───────────────────────────────────────────────────── */
async function handleGenerate() {
  const question = document.getElementById('questionInput').value.trim();
  if (!question) return;
  if (!S.apiKey) { showError('Please set your OpenAI API key in Settings.'); return; }

  // Hide examples after first search
  document.getElementById('examplesSection').style.display = 'none';
  S.currentQuestion = question;

  // Reset
  clearAllLayers();
  S.queries = [];
  S.selectedIds.clear();
  hideError();
  document.getElementById('queryOutput').style.display = 'none';
  showLoading('Generating query...');

  const MAX_RETRIES = 2;
  let retryContext = null;

  for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
    try {
      if (attempt > 0) showLoading(`Retrying with corrections (attempt ${attempt + 1} of ${MAX_RETRIES + 1})...`);

      const result = await callOpenAI(question, retryContext);

      // Validate that tags have documented OSM wiki pages
      const invalidTags = await checkWikiTags(result.queries || []);
      if (invalidTags.length > 0) {
        const tagList = invalidTags.map(t => t.tag).join(', ');
        if (attempt < MAX_RETRIES) {
          showLoading(`Tags not found in OSM wiki: ${tagList}. Retrying with valid tags (attempt ${attempt + 2} of ${MAX_RETRIES + 1})...`);
          retryContext = {
            previousResult: result,
            feedback: `The following OSM tags are not documented in the OpenStreetMap wiki and must not be used: ${tagList}. Please replace them with well-documented tags that have wiki pages (e.g. amenity=*, highway=*, shop=*, bicycle=*, etc.).`,
          };
          continue;
        }
        // Final attempt — warn user but proceed with what we have
        showError(`Note: some tags may not be well-documented in the OSM wiki: ${tagList}`);
      }

      hideLoading();
      clearAllLayers();
      S.queries = (result.queries || []).map(q => ({
        ...q, elements: [], layerGroup: null, elementLayers: new Map(), visible: true,
      }));
      renderQueryOutput(result.explanation || '', result.queries || []);

      if (!S.queries.length) break;

      const queryResult = await runQuery(0);

      if (queryResult?.error && attempt < MAX_RETRIES) {
        showLoading(`Overpass query error detected. Retrying with fix (attempt ${attempt + 2} of ${MAX_RETRIES + 1})...`);
        retryContext = {
          previousResult: result,
          feedback: `The Overpass QL query "${S.queries[0]?.name}" produced this error:\n${queryResult.error}\n\nProblematic Overpass QL:\n${queryResult.overpassQL}\n\nPlease correct the Overpass QL syntax. Most common mistake: placing [bbox:...] inside node/way/relation filters instead of the global settings line. The correct format is:\n[out:json][timeout:25][bbox:SOUTH,WEST,NORTH,EAST];\n(node[key=value];way[key=value];relation[key=value];);\nout geom;`,
        };
        continue;
      }

      break; // Success (or no more retries)
    } catch (err) {
      hideLoading();
      showError(err.message);
      return;
    }
  }

  hideLoading();
}

/* ── OpenAI ─────────────────────────────────────────────────────── */
async function callOpenAI(question, retryContext = null) {
  const b = S.map.getBounds();
  const bbox = `${b.getSouth().toFixed(6)},${b.getWest().toFixed(6)},${b.getNorth().toFixed(6)},${b.getEast().toFixed(6)}`;

  const system = `You are an expert at OpenStreetMap and Overpass QL queries.
Convert geographic questions into Overpass QL queries.
Reference: https://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL

Rules:
1. Generate 1–3 query variants (different tag combinations or levels of specificity).
2. Use the provided bounding box ONLY in the global settings line:
   [out:json][timeout:25][bbox:SOUTH,WEST,NORTH,EAST];
   NEVER place [bbox:...] inside node/way/relation filters — that is invalid Overpass QL syntax.
   ✓ CORRECT: [out:json][timeout:25][bbox:52.3,4.8,52.4,4.9];(node[amenity=cafe];way[amenity=cafe];relation[amenity=cafe];);out geom;
   ✗ WRONG:   [out:json][timeout:25];(node[amenity=cafe][bbox:52.3,4.8,52.4,4.9];way[amenity=cafe][bbox:52.3,4.8,52.4,4.9];relation[amenity=cafe][bbox:52.3,4.8,52.4,4.9];);out geom;
   If the user explicitly names a geographic area (city, country, region), use area-based filtering instead.
3. Always use [out:json][timeout:25] in the settings block.
4. Always end the query with: out geom;
   (This includes coordinates for ways and relations, required for map rendering.)
5. Combine node/way/relation with a union block: ( node[...]; way[...]; relation[...]; )
6. For every OSM tag used, add an entry in the "tags" array referencing the OSM wiki.
   Only use tags that are well-documented on the OSM wiki (https://wiki.openstreetmap.org).
   Most-used tags (amenity, highway, shop, bicycle, building, etc.) have wiki pages.
7. In each tag description clearly explain what the tag DOES and what it does NOT include.
8. For area-based queries use: area["name"="AREA_NAME"]->.a; ... (area.a); ...
   Area names can be ambiguous; always narrow down with admin_level to get the right boundary:
   - Countries: area["name"="COUNTRY"]["admin_level"="2"]->.a;
   - States/provinces: area["name"="REGION"]["admin_level"="4"]->.a;
   - Cities/municipalities: area["name"="CITY"]["admin_level"="8"]->.a;
   IMPORTANT: OSM stores area names in the LOCAL language, not English. Always translate the area name
   to its native/local form. Examples: "Netherlands" → "Nederland", "Germany" → "Deutschland",
   "Spain" → "España", "France" → "France", "Japan" → "日本", "China" → "中国".
   If unsure of the local name, also try the English name as a fallback variant.
   Always place the area filter (area.a) inside EACH node/way/relation filter:
   ✓ CORRECT: area["name"="Amsterdam"]["admin_level"="8"]->.a;(node["amenity"="school"](area.a);way["amenity"="school"](area.a);relation["amenity"="school"](area.a););out geom;
   ✗ WRONG:   area["name"="Amsterdam"]->.a;(node["amenity"="school"];way["amenity"="school"];relation["amenity"="school"];);out geom;
9. Overpass QL tag filters use key=value syntax, e.g. [amenity=cafe], [highway=cycleway].
   Colons are only valid inside a key name itself (e.g. [addr:city=Amsterdam]).
10. When using specific subtags that may not be universally applied (e.g. school:level, sport, cuisine),
    always include a broader fallback query variant (e.g. just amenity=school) in addition to the specific one.
11. Prefer well-known, commonly used OSM key=value pairs. Use this comprehensive lookup table of currently used OSM tags (each key maps to its known values):
${JSON.stringify(OSM_TAG_LOOKUP)}

Return ONLY valid JSON matching this schema (no markdown, no code fences):
{
  "explanation": "Overall description of the approach",
  "queries": [
    {
      "name": "Short variant name",
      "description": "What this query finds and what it excludes",
      "overpassQL": "complete valid Overpass QL string",
      "tags": [
        {
          "tag": "key=value",
          "url": "https://wiki.openstreetmap.org/wiki/Tag:key%3Dvalue",
          "description": "What this tag covers and importantly what it does NOT include"
        }
      ]
    }
  ]
}`;

  const user = `Geographic question: ${question}
Current map bounding box (south,west,north,east): ${bbox}
Use this bbox in your queries unless the user specified a named area.`;

  const messages = [
    { role: 'system', content: system },
    { role: 'user', content: user },
  ];

  if (retryContext) {
    messages.push({ role: 'assistant', content: JSON.stringify(retryContext.previousResult) });
    messages.push({ role: 'user', content: retryContext.feedback });
  }

  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${S.apiKey}` },
    body: JSON.stringify({
      model: S.model,
      messages,
      response_format: { type: 'json_object' },
      temperature: 0.2,
      max_tokens: 4096,
    }),
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error?.message || `OpenAI API error ${res.status}`);
  }

  const data = await res.json();
  const content = data.choices?.[0]?.message?.content || '';
  try { return JSON.parse(content); }
  catch { throw new Error('Could not parse AI response. Try again.'); }
}

/* ── Wiki tag validation ────────────────────────────────────────── */
async function checkWikiTags(queries) {
  const allTags = [];
  const seen = new Set();
  queries.forEach(q => (q.tags || []).forEach(t => {
    if (!seen.has(t.tag)) { seen.add(t.tag); allTags.push(t); }
  }));
  if (!allTags.length) return [];

  // For each tag generate candidate page titles (URL title + Key:keyname fallback)
  const checks = allTags.map(t => {
    const urlMatch = (t.url || '').match(/wiki\.openstreetmap\.org\/wiki\/(.+)$/);
    const urlTitle = urlMatch ? decodeURIComponent(urlMatch[1]) : null;
    const keyTitle = t.tag.includes('=') ? `Key:${t.tag.split('=')[0]}` : `Key:${t.tag}`;
    const titles = [...new Set([urlTitle, keyTitle].filter(Boolean))];
    return { tag: t, titles, titlesLower: titles.map(s => s.toLowerCase()) };
  });

  const allTitles = [...new Set(checks.flatMap(c => c.titles))].slice(0, 50);
  if (!allTitles.length) return [];

  try {
    const apiUrl = `https://wiki.openstreetmap.org/w/api.php?action=query&titles=${allTitles.map(encodeURIComponent).join('|')}&format=json&origin=*`;
    const res = await fetch(apiUrl);
    const data = await res.json();
    const pages = Object.values(data.query?.pages || {});
    const existingTitles = new Set(pages.filter(p => !('missing' in p)).map(p => p.title.toLowerCase()));
    // A tag is invalid only if ALL its candidate titles are missing
    return checks
      .filter(c => c.titlesLower.every(t => !existingTitles.has(t)))
      .map(c => c.tag);
  } catch (_) {
    return []; // If the check fails, assume all tags are valid
  }
}

/* ── Overpass execution ─────────────────────────────────────────── */
async function runQuery(idx) {
  const q = S.queries[idx];
  if (!q) return null;

  setActiveVariant(idx);
  setStatus(`Executing "${q.name}"...`);
  setVariantCount(idx, 'Loading...');

  // Replace {{bbox}} placeholder if model used it
  const b = S.map.getBounds();
  const bbox = `${b.getSouth().toFixed(6)},${b.getWest().toFixed(6)},${b.getNorth().toFixed(6)},${b.getEast().toFixed(6)}`;
  const oql = q.overpassQL.replace(/\{\{bbox\}\}/g, bbox);

  try {
    const data = await fetchOverpass(oql);
    const elements = (data.elements || []).filter(el =>
      (el.type === 'node' && el.lat != null) ||
      (el.type === 'way'  && el.geometry)    ||
      (el.type === 'relation' && el.members)
    );
    S.queries[idx].elements = elements;
    renderOnMap(idx, elements);
    renderResultsList();
    const countLabel = elements.length > 1000
      ? `${elements.length} results (map shows first 1000)`
      : `${elements.length} result${elements.length !== 1 ? 's' : ''}`;
    setVariantCount(idx, countLabel);
    setStatus(`"${q.name}" — ${elements.length} results`);
    updateStatusResults();

    // Fit to results if there are any
    if (elements.length > 0) fitResults();
    return { error: null };
  } catch (err) {
    setVariantCount(idx, 'Error');
    setStatus(`Query error: ${err.message}`);
    return { error: err.message, overpassQL: oql };
  }
}

async function fetchOverpass(oql) {
  const res = await fetch('https://overpass-api.de/api/interpreter', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `data=${encodeURIComponent(oql)}`,
  });
  const text = await res.text();
  if (!res.ok) {
    const errText = extractOverpassError(text);
    throw new Error(errText || `Overpass API error ${res.status}`);
  }
  try {
    const json = JSON.parse(text);
    if (json.remark && !json.elements) throw new Error(json.remark);
    return json;
  } catch (e) {
    if (e.message.startsWith('Overpass') || e.message.startsWith('runtime')) throw e;
    const errText = extractOverpassError(text);
    if (errText) throw new Error(errText);
    throw new Error('Failed to parse Overpass response');
  }
}

function extractOverpassError(html) {
  try {
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const errors = [...doc.querySelectorAll('p')]
      .map(p => p.textContent.trim())
      .filter(t => /error/i.test(t) && t.length > 0);
    return errors.join(' ');
  } catch (_) { return ''; }
}

/* ── Map rendering ──────────────────────────────────────────────── */
function renderOnMap(idx, elements) {
  if (S.queries[idx].layerGroup) S.map.removeLayer(S.queries[idx].layerGroup);
  const color   = COLORS[idx % COLORS.length];
  const lg      = L.layerGroup().addTo(S.map);
  const elLayers = new Map();
  const areaFallbacks = [];

  // Limit rendering for performance; excess elements are still listed in the results panel
  const MAX_RENDER = 1000;
  const toRender = elements.slice(0, MAX_RENDER);

  toRender.forEach(el => {
    const eid   = elId(el);
    const name  = elName(el);
    let layer   = null;

    if (el.type === 'node') {
      layer = L.circleMarker([el.lat, el.lon], nodeStyle(color));
    } else if (el.type === 'way' && el.geometry) {
      const pts     = el.geometry.map(p => [p.lat, p.lon]);
      const firstPt = pts[0];
      const lastPt  = pts[pts.length - 1];
      const closed  = pts.length > 2 && firstPt[0] === lastPt[0] && firstPt[1] === lastPt[1];
      if (closed && isAreaEl(el.tags)) {
        layer = L.polygon(pts, polyStyle(color));
        // Create a fallback dot shown when the polygon is too small to see
        const center = layer.getBounds().getCenter();
        const fallback = L.circleMarker([center.lat, center.lng], { ...nodeStyle(color), opacity: 0, fillOpacity: 0 });
        fallback.bindPopup(buildPopup(el, name, color));
        fallback.on('click', () => { toggleSel(eid); renderResultsList(); });
        lg.addLayer(fallback);
        areaFallbacks.push({ poly: layer, fallback, eid });
      } else {
        layer = L.polyline(pts, lineStyle(color));
      }
    } else if (el.type === 'relation' && el.members) {
      const ways = el.members.filter(m => m.type === 'way' && m.geometry);
      if (ways.length) {
        layer = L.polyline(ways.map(w => w.geometry.map(p => [p.lat, p.lon])), lineStyle(color));
      }
    }

    if (layer) {
      layer.bindPopup(buildPopup(el, name, color));
      layer.on('click', () => { toggleSel(eid); renderResultsList(); });
      layer.on('mouseover', () => hlLayer(layer, el.type, true,  color));
      layer.on('mouseout',  () => { if (!S.selectedIds.has(eid)) hlLayer(layer, el.type, false, color); });
      lg.addLayer(layer);
      elLayers.set(eid, layer);
    }
  });

  S.queries[idx].layerGroup    = lg;
  S.queries[idx].elementLayers = elLayers;
  S.queries[idx].areaFallbacks = areaFallbacks;

  // Apply initial area-dot logic for the current zoom level
  updateAreaDots();
}

function nodeStyle(c) { return { radius: STYLE.NODE_RADIUS, fillColor: c, color: '#fff', weight: STYLE.NODE_WEIGHT, fillOpacity: 0.85, opacity: 1 }; }
function lineStyle(c) { return { color: c, weight: STYLE.LINE_WEIGHT, opacity: 0.8 }; }
function polyStyle(c) { return { color: c, weight: 2, fillColor: c, fillOpacity: 0.18, opacity: 0.8 }; }

/* ── Area dot fallback ──────────────────────────────────────────── */
let _areaDotTimer = null;
function updateAreaDots() {
  // Debounce to avoid excessive recalculation during rapid zoom events
  clearTimeout(_areaDotTimer);
  _areaDotTimer = setTimeout(_applyAreaDots, 50);
}
function _applyAreaDots() {
  if (!S.map) return;
  S.queries.forEach((q, qi) => {
    if (!q.areaFallbacks || !q.areaFallbacks.length) return;
    const color = COLORS[qi % COLORS.length];
    q.areaFallbacks.forEach(({ poly, fallback, eid }) => {
      try {
        const bounds = poly.getBounds();
        if (!bounds.isValid()) return;
        const sw = S.map.latLngToContainerPoint(bounds.getSouthWest());
        const ne = S.map.latLngToContainerPoint(bounds.getNorthEast());
        const pxSize = Math.max(Math.abs(ne.x - sw.x), Math.abs(ne.y - sw.y));
        const tooSmall = pxSize < AREA_MIN_PX;
        const sel = S.selectedIds.has(eid);
        if (tooSmall) {
          // Hide polygon, show dot
          poly.setStyle({ opacity: 0, fillOpacity: 0 });
          fallback.setStyle({ opacity: 1, fillOpacity: 0.85, fillColor: sel ? SEL_COLOR : color, color: sel ? color : '#fff', weight: sel ? STYLE.NODE_WEIGHT_SEL : STYLE.NODE_WEIGHT, radius: sel ? STYLE.NODE_RADIUS_SEL : STYLE.NODE_RADIUS });
        } else {
          // Show polygon, hide dot
          poly.setStyle(sel ? { color: SEL_COLOR, weight: STYLE.LINE_WEIGHT_SEL, fillColor: color, fillOpacity: 0.25, opacity: 1 } : polyStyle(color));
          fallback.setStyle({ opacity: 0, fillOpacity: 0 });
        }
      } catch(_) {}
    });
  });
  // Also apply area-dot logic for shown saved searches
  Object.values(S.shownSearches).forEach(shown => {
    (shown.areaFallbacks || []).forEach(({ poly, fallback, eid, color }) => {
      try {
        const bounds = poly.getBounds();
        if (!bounds.isValid()) return;
        const sw = S.map.latLngToContainerPoint(bounds.getSouthWest());
        const ne = S.map.latLngToContainerPoint(bounds.getNorthEast());
        const pxSize = Math.max(Math.abs(ne.x - sw.x), Math.abs(ne.y - sw.y));
        const tooSmall = pxSize < AREA_MIN_PX;
        if (tooSmall) {
          poly.setStyle({ opacity: 0, fillOpacity: 0 });
          fallback.setStyle({ opacity: 1, fillOpacity: 0.85, fillColor: color, color: '#fff', weight: STYLE.NODE_WEIGHT, radius: STYLE.NODE_RADIUS });
        } else {
          poly.setStyle(polyStyle(color));
          fallback.setStyle({ opacity: 0, fillOpacity: 0 });
        }
      } catch(_) {}
    });
  });
}

function isAreaEl(tags = {}) {
  return ['building','landuse','leisure','natural','amenity','shop'].some(k => k in tags) || tags.area === 'yes';
}

function elId(el)   { return `${el.type}-${el.id}`; }
function elName(el) {
  const t = el.tags || {};
  return t.name || t['name:en'] || t.ref || `${el.type} ${el.id}`;
}

function buildPopup(el, name, color) {
  const tags = el.tags || {};
  const rows = Object.entries(tags).slice(0, 8).map(([k, v]) =>
    `<div style="display:flex;gap:8px;padding:2px 0;font-size:11px;"><span style="color:var(--text-1);min-width:75px;flex-shrink:0;">${esc(k)}</span><span>${esc(v)}</span></div>`
  ).join('');
  const more = Object.keys(tags).length > 8 ? `<div style="font-size:10px;color:var(--text-2);margin-top:3px;">+${Object.keys(tags).length - 8} more tags</div>` : '';
  return `<div style="min-width:200px;max-width:280px;"><div style="font-weight:700;margin-bottom:5px;color:${color};">${esc(name)}</div><div style="font-size:10px;color:var(--text-2);margin-bottom:6px;">${el.type.toUpperCase()} #${el.id}</div>${rows}${more}</div>`;
}

function hlLayer(layer, type, on, color) {
  try {
    if (type === 'node') layer.setStyle({ weight: on ? STYLE.NODE_WEIGHT_HL : STYLE.NODE_WEIGHT, radius: on ? STYLE.NODE_RADIUS_SEL : STYLE.NODE_RADIUS });
    else layer.setStyle({ weight: on ? STYLE.LINE_WEIGHT_HL : STYLE.LINE_WEIGHT, opacity: on ? 1 : 0.8 });
  } catch(_) {}
}

function clearAllLayers() {
  S.queries.forEach(q => { if (q.layerGroup) S.map.removeLayer(q.layerGroup); });
  Object.values(S.shownSearches).forEach(shown => {
    shown.layerGroups.forEach(lg => { if (lg) S.map.removeLayer(lg); });
  });
  S.shownSearches = {};
  renderSavedSearches();
}

/* ── Results list ───────────────────────────────────────────────── */
function renderResultsList() {
  const container = document.getElementById('resultsList');
  const empty     = document.getElementById('resultsEmpty');

  const all = [];
  S.queries.forEach((q, qi) => (q.elements || []).forEach(el => all.push({ el, qi })));

  if (!all.length) { empty.style.display = 'flex'; container.innerHTML = ''; container.appendChild(empty); return; }
  empty.style.display = 'none';

  const MAX_LIST = 500;
  const frag = document.createDocumentFragment();

  all.slice(0, MAX_LIST).forEach(({ el, qi }) => {
    const color = COLORS[qi % COLORS.length];
    const eid   = elId(el);
    const sel   = S.selectedIds.has(eid);

    const item = document.createElement('div');
    item.className = `result-item${sel ? ' selected' : ''}`;
    item.dataset.eid = eid;
    item.innerHTML = `
      <div class="result-bar" style="background:${color};"></div>
      <div class="result-inner">
        <div class="result-name">${esc(elName(el))}</div>
        <div class="result-meta">${el.type} &bull; ${esc(S.queries[qi]?.name || '')}</div>
      </div>`;
    item.addEventListener('click', () => {
      toggleSel(eid);
      renderResultsList();
      flyTo(el, qi);
    });
    frag.appendChild(item);
  });

  if (all.length > MAX_LIST) {
    const note = document.createElement('div');
    note.className = 'results-limit-note';
    note.textContent = `Showing ${MAX_LIST} of ${all.length} results`;
    frag.appendChild(note);
  }

  container.innerHTML = '';
  container.appendChild(empty);
  empty.style.display = 'none';
  container.appendChild(frag);
}

function flyTo(el, qi) {
  if (el.type === 'node') {
    S.map.flyTo([el.lat, el.lon], Math.max(S.map.getZoom(), 16), { duration: 0.4 });
  } else {
    const layer = S.queries[qi]?.elementLayers?.get(elId(el));
    if (layer?.getBounds) S.map.flyToBounds(layer.getBounds(), { padding: [40, 40], duration: 0.4 });
  }
}

function fitResults() {
  const pts = [];
  S.queries.forEach(q => {
    (q.elements || []).forEach(el => {
      if (el.type === 'node') pts.push([el.lat, el.lon]);
      else if (el.type === 'way' && el.geometry) el.geometry.forEach(p => pts.push([p.lat, p.lon]));
    });
  });
  if (pts.length) S.map.fitBounds(L.latLngBounds(pts), { padding: [30, 30] });
}

/* ── Selection ──────────────────────────────────────────────────── */
function toggleSel(eid) {
  if (S.selectedIds.has(eid)) S.selectedIds.delete(eid);
  else S.selectedIds.add(eid);
  syncLayerStyles();
  updateStatusResults();
}

function clearSelection() {
  S.selectedIds.clear();
  syncLayerStyles();
  renderResultsList();
  updateStatusResults();
}

function syncLayerStyles() {
  S.queries.forEach((q, qi) => {
    const color = COLORS[qi % COLORS.length];
    q.elementLayers?.forEach((layer, eid) => {
      const el  = q.elements.find(e => elId(e) === eid);
      if (!el) return;
      const sel = S.selectedIds.has(eid);
      try {
        if (el.type === 'node') {
          layer.setStyle({ fillColor: sel ? SEL_COLOR : color, color: sel ? color : '#fff', weight: sel ? STYLE.NODE_WEIGHT_SEL : STYLE.NODE_WEIGHT, radius: sel ? STYLE.NODE_RADIUS_SEL : STYLE.NODE_RADIUS });
        } else {
          layer.setStyle({ color: sel ? SEL_COLOR : color, weight: sel ? STYLE.LINE_WEIGHT_SEL : STYLE.LINE_WEIGHT, opacity: sel ? 1 : 0.8 });
        }
      } catch(_) {}
    });
  });
  // Also update area fallback dots and polygon selection state
  updateAreaDots();
}

/* ── Brush selection ────────────────────────────────────────────── */
function toggleBrush() {
  S.brush.active = !S.brush.active;
  document.getElementById('brushBtn').classList.toggle('active', S.brush.active);

  if (S.brush.active) {
    S.map.dragging.disable();
    S.map.scrollWheelZoom.disable();
    S.map.doubleClickZoom.disable();

    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:absolute;inset:0;z-index:1500;cursor:crosshair;';
    document.querySelector('.map-container').appendChild(overlay);
    S.brush.overlayEl = overlay;

    overlay.addEventListener('mousedown',  onBrushDown);
    overlay.addEventListener('mousemove',  onBrushMove);
    overlay.addEventListener('mouseup',    onBrushUp);
    overlay.addEventListener('mouseleave', onBrushUp);
  } else {
    S.map.dragging.enable();
    S.map.scrollWheelZoom.enable();
    S.map.doubleClickZoom.enable();
    S.brush.overlayEl?.remove();
    S.brush.overlayEl = null;
    S.brush.start = null;
    if (S.brush.rectLayer) { S.map.removeLayer(S.brush.rectLayer); S.brush.rectLayer = null; }
  }
}

function pxToLatLng(e) {
  const r = document.getElementById('map').getBoundingClientRect();
  return S.map.containerPointToLatLng(L.point(e.clientX - r.left, e.clientY - r.top));
}

function onBrushDown(e)  { S.brush.start = pxToLatLng(e); }
function onBrushMove(e)  {
  if (!S.brush.start) return;
  const cur = pxToLatLng(e);
  const bounds = L.latLngBounds(S.brush.start, cur);
  if (S.brush.rectLayer) S.map.removeLayer(S.brush.rectLayer);
  S.brush.rectLayer = L.rectangle(bounds, { color: '#0a84ff', weight: 1, fillColor: '#0a84ff', fillOpacity: 0.08, dashArray: '5 3' }).addTo(S.map);
}
function onBrushUp(e)    {
  if (!S.brush.start) return;
  const cur    = pxToLatLng(e);
  const bounds = L.latLngBounds(S.brush.start, cur);
  S.brush.start = null;

  S.selectedIds.clear();
  S.queries.forEach(q => {
    (q.elements || []).forEach(el => {
      let hit = false;
      if (el.type === 'node') hit = bounds.contains([el.lat, el.lon]);
      else if (el.type === 'way' && el.geometry) hit = el.geometry.some(p => bounds.contains([p.lat, p.lon]));
      if (hit) S.selectedIds.add(elId(el));
    });
  });

  syncLayerStyles();
  renderResultsList();
  updateStatusResults();
  toggleBrush(); // deactivate after selection
}

/* ── Query variant UI ───────────────────────────────────────────── */
function renderQueryOutput(explanation, queries) {
  document.getElementById('explanationBox').textContent = explanation;

  const vc = document.getElementById('queryVariants');
  vc.innerHTML = '';

  queries.forEach((q, idx) => {
    const color = COLORS[idx % COLORS.length];
    const div   = document.createElement('div');
    div.className = `query-variant${idx === 0 ? ' active' : ''}`;
    div.dataset.idx = idx;

    div.innerHTML = `
      <div class="qv-header">
        <div class="qv-dot" style="background:${color};"></div>
        <span class="qv-name">${esc(q.name)}</span>
        <span class="qv-vis" data-idx="${idx}" title="Toggle visibility"><i class="fa-regular fa-eye"></i></span>
        <span class="qv-reapply" data-idx="${idx}" title="Re-apply to current bounding box (removes area filters)" style="font-size:11px;padding:1px 5px;border-radius:2px;border:1px solid var(--border-mid);color:var(--text-1);background:var(--bg-3);cursor:pointer;line-height:1.4;"><i class="fa-solid fa-crosshairs"></i></span>
        <span class="qv-save" data-idx="${idx}" title="Save this search to local storage" style="font-size:11px;padding:1px 5px;border-radius:2px;border:1px solid var(--border-mid);color:var(--text-1);background:var(--bg-3);cursor:pointer;line-height:1.4;"><i class="fa-regular fa-bookmark"></i></span>
        <span class="qv-count" data-idx="${idx}">-</span>
      </div>
      <div class="qv-body">
        ${esc(q.description)}
        <div><button class="qv-code-toggle" data-idx="${idx}">Show query</button></div>
        <pre class="qv-code" data-idx="${idx}">${esc(q.overpassQL)}</pre>
      </div>`;

    // Click header → activate + execute if needed
    div.querySelector('.qv-header').addEventListener('click', async e => {
      if (e.target.closest('.qv-vis')) return; // handled separately
      if (e.target.closest('.qv-save')) return; // handled separately
      if (e.target.closest('.qv-reapply')) return; // handled separately
      document.querySelectorAll('.query-variant').forEach(el => el.classList.remove('active'));
      div.classList.add('active');
      if (!S.queries[idx]?.elements?.length) await runQuery(idx);
    });

    // Save button
    div.querySelector('.qv-save').addEventListener('click', e => {
      e.stopPropagation();
      saveSearch(S.currentQuestion, queries, idx);
      const icon = e.currentTarget.querySelector('i');
      if (icon) { icon.className = 'fa-solid fa-bookmark'; }
      setTimeout(() => { if (icon) icon.className = 'fa-regular fa-bookmark'; }, 1500);
    });

    // Reapply to current bounding box
    div.querySelector('.qv-reapply').addEventListener('click', e => {
      e.stopPropagation();
      reapplyToBbox(idx);
    });

    // Visibility toggle
    div.querySelector('.qv-vis').addEventListener('click', e => {
      e.stopPropagation();
      const q2 = S.queries[idx];
      if (!q2) return;
      q2.visible = !q2.visible;
      const icon = e.currentTarget.querySelector('i');
      if (icon) icon.className = q2.visible ? 'fa-regular fa-eye' : 'fa-regular fa-eye-slash';
      if (q2.layerGroup) {
        if (q2.visible) S.map.addLayer(q2.layerGroup);
        else S.map.removeLayer(q2.layerGroup);
      }
    });

    // Code toggle
    div.querySelector('.qv-code-toggle').addEventListener('click', e => {
      const pre = div.querySelector('.qv-code');
      const on  = pre.style.display === 'block';
      pre.style.display = on ? 'none' : 'block';
      e.target.textContent = on ? 'Show query' : 'Hide query';
    });

    vc.appendChild(div);
  });

  // Wiki references (deduplicated)
  const seen = new Set(), allTags = [];
  queries.forEach(q => (q.tags || []).forEach(t => { if (!seen.has(t.tag)) { seen.add(t.tag); allTags.push(t); } }));

  const wikiList = document.getElementById('wikiRefsList');
  wikiList.innerHTML = '';
  if (allTags.length) {
    document.getElementById('wikiSection').style.display = 'block';
    allTags.forEach(t => {
      const d = document.createElement('div');
      d.className = 'wiki-ref';
      d.innerHTML = `<div class="wiki-tag"><a href="${safeUrl(t.url)}" target="_blank" rel="noopener noreferrer">${esc(t.tag)}</a></div><div class="wiki-desc">${esc(t.description)}</div>`;
      wikiList.appendChild(d);
    });
  } else {
    document.getElementById('wikiSection').style.display = 'none';
  }

  document.getElementById('queryOutput').style.display = 'block';
}

function setActiveVariant(idx) {
  document.querySelectorAll('.query-variant').forEach((el, i) => el.classList.toggle('active', i === idx));
}

function setVariantCount(idx, text) {
  const el = document.querySelector(`.qv-count[data-idx="${idx}"]`);
  if (el) el.textContent = text;
}

/* ── GPX export ─────────────────────────────────────────────────── */
function exportGPX() {
  const all = [];
  S.queries.forEach((q, qi) => {
    (q.elements || []).forEach(el => {
      const eid = elId(el);
      if (!S.selectedIds.size || S.selectedIds.has(eid)) all.push({ el, qname: q.name });
    });
  });

  if (!all.length) { showError('No elements to export. Generate a query first.'); return; }

  const now = new Date().toISOString();
  let wpts = '', trks = '';

  all.forEach(({ el, qname }) => {
    const name = elName(el);
    const tags = el.tags || {};
    const desc = Object.entries(tags).slice(0, 6).map(([k, v]) => `${k}=${v}`).join('; ');

    if (el.type === 'node') {
      wpts += `  <wpt lat="${el.lat}" lon="${el.lon}">\n    <name>${escXml(name)}</name>\n    <desc>${escXml(desc)}</desc>\n  </wpt>\n`;
    } else if (el.type === 'way' && el.geometry) {
      const pts = el.geometry.map(p => `      <trkpt lat="${p.lat}" lon="${p.lon}"/>`).join('\n');
      trks += `  <trk>\n    <name>${escXml(name)}</name>\n    <desc>${escXml(desc)}</desc>\n    <trkseg>\n${pts}\n    </trkseg>\n  </trk>\n`;
    }
  });

  const gpx = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="Overpass AI" xmlns="http://www.topografix.com/GPX/1/1">\n  <metadata><name>Overpass AI Export</name><time>${now}</time></metadata>\n${wpts}${trks}</gpx>`;

  const blob = new Blob([gpx], { type: 'application/gpx+xml' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = `overpass-ai-${Date.now()}.gpx`; a.click();
  URL.revokeObjectURL(url);
}

/* ── Re-apply to current bounding box ──────────────────────────── */
function reapplyToBbox(idx) {
  const q = S.queries[idx];
  if (!q) return;
  const b = S.map.getBounds();
  const bbox = `${b.getSouth().toFixed(6)},${b.getWest().toFixed(6)},${b.getNorth().toFixed(6)},${b.getEast().toFixed(6)}`;

  let oql = q.overpassQL;

  // Remove area definition lines (e.g. area["name"="..."]->.a;)
  oql = oql.replace(/\barea\s*(?:\[[^\]]*\]\s*)*->\s*\.\w+\s*;\s*/g, '');

  // Remove area filter references inside geo filters (e.g. (area.a))
  oql = oql.replace(/\s*\(\s*area\s*\.\s*\w+\s*\)/g, '');

  // Update or insert bbox in the global settings line
  if (/\[bbox:[^\]]*\]/.test(oql)) {
    oql = oql.replace(/\[bbox:[^\]]*\]/, `[bbox:${bbox}]`);
  } else {
    // Add bbox before the closing semicolon of the settings line
    oql = oql.replace(/(\[out:[^\]]*\](?:\[[^\]]*\])*)\s*;/, `$1[bbox:${bbox}];`);
  }

  S.queries[idx].overpassQL = oql;

  // Update the displayed code block
  const pre = document.querySelector(`.qv-code[data-idx="${idx}"]`);
  if (pre) pre.textContent = oql;

  runQuery(idx);
}

/* ── CSV export (modal) ─────────────────────────────────────────── */
function openCsvExport() {
  const all = getAllExportElements();
  if (!all.length) { showError('No elements to export. Generate a query first.'); return; }

  // Collect tag keys and value frequencies
  const tagFreq = {};  // key → Map(value → count)
  const SYSTEM_FIELDS = ['id', 'type', 'name', 'lat', 'lon', 'query'];

  all.forEach(({ el }) => {
    Object.entries(el.tags || {}).forEach(([k, v]) => {
      if (!tagFreq[k]) tagFreq[k] = new Map();
      tagFreq[k].set(v, (tagFreq[k].get(v) || 0) + 1);
    });
  });

  const sortedKeys = Object.keys(tagFreq).sort();
  const container  = document.getElementById('csvFieldList');
  container.innerHTML = '';

  // Render system field rows (always included, locked)
  const sysHeader = document.createElement('div');
  sysHeader.style.cssText = 'padding:6px 10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-2);';
  sysHeader.textContent = 'System Fields (always included)';
  container.appendChild(sysHeader);

  SYSTEM_FIELDS.forEach(f => {
    const row = document.createElement('div');
    row.className = 'csv-field-row';
    row.innerHTML = `<div class="csv-field-header"><input type="checkbox" checked disabled style="opacity:.5;"> <span class="csv-field-label">${esc(f)}</span></div>`;
    container.appendChild(row);
  });

  if (sortedKeys.length) {
    const tagHeader = document.createElement('div');
    tagHeader.style.cssText = 'padding:6px 10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-2);border-top:1px solid var(--border);margin-top:4px;';
    tagHeader.textContent = 'OSM Tag Fields';
    container.appendChild(tagHeader);
  }

  sortedKeys.forEach(key => {
    const freq = tagFreq[key];
    const total = [...freq.values()].reduce((a, b) => a + b, 0);

    // Top 8 values by frequency
    const topValues = [...freq.entries()]
      .sort((a, b) => b[1] - a[1])
      .slice(0, 8);

    const row = document.createElement('div');
    row.className = 'csv-field-row';
    row.dataset.key = key;

    const chips = topValues.map(([val, cnt]) => {
      const chip = `<span class="csv-value-chip" data-key="${esc(key)}" data-value="${esc(val)}" title="Hover to highlight on map">${esc(val)} <span class="chip-count">${cnt}</span></span>`;
      return chip;
    }).join('');

    const moreNote = freq.size > 8 ? `<span style="font-size:10px;color:var(--text-2);padding:1px 4px;">+${freq.size - 8} more</span>` : '';

    row.innerHTML = `
      <div class="csv-field-header">
        <input type="checkbox" checked data-field-key="${esc(key)}">
        <span class="csv-field-label">${esc(key)}</span>
        <span class="csv-field-count">${total} values</span>
      </div>
      <div class="csv-value-chips">${chips}${moreNote}</div>`;
    container.appendChild(row);
  });

  // Hover to highlight
  container.querySelectorAll('.csv-value-chip').forEach(chip => {
    chip.addEventListener('mouseenter', () => highlightByTagValue(chip.dataset.key, chip.dataset.value));
    chip.addEventListener('mouseleave', clearTagHighlight);
  });

  document.getElementById('csvExportOverlay').classList.add('open');
}

function doExportCsv() {
  const all = getAllExportElements();
  if (!all.length) return;

  const checkedKeys = [...document.querySelectorAll('#csvFieldList input[type="checkbox"]:not(:disabled):checked')]
    .map(cb => cb.dataset.fieldKey);

  const escCsv = v => {
    const s = String(v ?? '');
    return s.includes(',') || s.includes('"') || s.includes('\n') ? `"${s.replace(/"/g, '""')}"` : s;
  };

  const header = ['id', 'type', 'name', 'lat', 'lon', 'query', ...checkedKeys].map(escCsv).join(',');
  const rows = all.map(({ el, qname }) => {
    const tags = el.tags || {};
    const lat = el.type === 'node' ? el.lat : (el.geometry?.[0]?.lat ?? '');
    const lon = el.type === 'node' ? el.lon : (el.geometry?.[0]?.lon ?? '');
    return [el.id, el.type, elName(el), lat, lon, qname, ...checkedKeys.map(k => tags[k] ?? '')].map(escCsv).join(',');
  });

  const csv = [header, ...rows].join('\n');
  downloadBlob(csv, `overpass-ai-${Date.now()}.csv`, 'text/csv;charset=utf-8;');
  document.getElementById('csvExportOverlay').classList.remove('open');
}

// Keep the old function name as an alias for backwards-compatibility (share-loaded queries, etc.)
function exportCSV() { openCsvExport(); }

/* ── Tag-value map highlight ────────────────────────────────────── */
let _tagHighlightState = []; // [{layer, origStyle}]
function highlightByTagValue(key, value) {
  clearTagHighlight();
  S.queries.forEach((q, qi) => {
    const color = COLORS[qi % COLORS.length];
    (q.elements || []).forEach(el => {
      const v = (el.tags || {})[key];
      const eid = elId(el);
      const layer = q.elementLayers?.get(eid);
      if (!layer) return;
      const matches = v === value;
      try {
        if (el.type === 'node') {
          const cur = { fillColor: layer.options.fillColor, radius: layer.options.radius, opacity: layer.options.opacity, fillOpacity: layer.options.fillOpacity };
          _tagHighlightState.push({ layer, origStyle: cur });
          layer.setStyle(matches
            ? { fillColor: SEL_COLOR, radius: STYLE.NODE_RADIUS_SEL, opacity: 1, fillOpacity: 1 }
            : { fillColor: color, radius: STYLE.NODE_RADIUS, opacity: 0.25, fillOpacity: 0.25 });
        } else {
          const cur = { color: layer.options.color, weight: layer.options.weight, opacity: layer.options.opacity };
          _tagHighlightState.push({ layer, origStyle: cur });
          layer.setStyle(matches
            ? { color: SEL_COLOR, weight: STYLE.LINE_WEIGHT_SEL, opacity: 1 }
            : { color, weight: STYLE.LINE_WEIGHT, opacity: 0.2 });
        }
      } catch(_) {}
    });
  });
}
function clearTagHighlight() {
  _tagHighlightState.forEach(({ layer, origStyle }) => { try { layer.setStyle(origStyle); } catch(_) {} });
  _tagHighlightState = [];
}

/* ── SVG export ─────────────────────────────────────────────────── */
function openSvgExport() {
  const all = getAllExportElements();
  if (!all.length) { showError('No elements to export. Generate a query first.'); return; }
  document.getElementById('svgExportOverlay').classList.add('open');
}

async function doExportSvg() {
  document.getElementById('svgExportOverlay').classList.remove('open');

  const forceDots   = document.querySelector('input[name="svgStyle"]:checked')?.value === 'dots';
  const includeTiles = document.getElementById('svgTilesCheck').checked;

  const b     = S.map.getBounds();
  const zoom  = S.map.getZoom();
  const W     = document.getElementById('map').clientWidth  || 800;
  const H     = document.getElementById('map').clientHeight || 600;

  // Mercator helpers (Web Mercator / EPSG:3857 pixel coords at given zoom)
  const TILE_SIZE = 256;
  function latToY(lat) {
    const sin = Math.sin(lat * Math.PI / 180);
    return (0.5 - Math.log((1 + sin) / (1 - sin)) / (4 * Math.PI)) * TILE_SIZE * Math.pow(2, zoom);
  }
  function lonToX(lon) {
    return ((lon + 180) / 360) * TILE_SIZE * Math.pow(2, zoom);
  }

  const originX = lonToX(b.getWest());
  const originY = latToY(b.getNorth());
  const scale   = W / (lonToX(b.getEast()) - originX);

  function geoToSvg(lat, lon) {
    return { x: (lonToX(lon) - originX) * scale, y: (latToY(lat) - originY) * scale };
  }

  // Collect tile URLs for current view
  async function getTileImages() {
    const tileZ    = Math.round(zoom);
    const tileSize = TILE_SIZE;
    const n        = Math.pow(2, tileZ);

    function latToTileY(lat) { return Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * n); }
    function lonToTileX(lon) { return Math.floor((lon + 180) / 360 * n); }

    const x0 = lonToTileX(b.getWest());
    const x1 = lonToTileX(b.getEast());
    const y0 = latToTileY(b.getNorth());
    const y1 = latToTileY(b.getSouth());

    const tiles = [];
    for (let tx = x0; tx <= x1; tx++) {
      for (let ty = y0; ty <= y1; ty++) {
        const url  = `https://tile.openstreetmap.org/${tileZ}/${tx}/${ty}.png`;
        const px   = (tx * tileSize - originX) * scale;
        const py   = (ty * tileSize - originY) * scale;
        const tw   = tileSize * scale;
        tiles.push({ url, px, py, tw });
      }
    }

    // Fetch tiles as data URLs for embedding
    const results = await Promise.all(tiles.map(async t => {
      try {
        const resp = await fetch(t.url);
        const blob = await resp.blob();
        const dataUrl = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(blob); });
        return { ...t, dataUrl };
      } catch (_) {
        return { ...t, dataUrl: t.url };
      }
    }));
    return results;
  }

  setStatus('Generating SVG…');

  let tileImgs = [];
  if (includeTiles) {
    try { tileImgs = await getTileImages(); } catch(_) {}
  }

  const svgNS = 'http://www.w3.org/2000/svg';
  const svg   = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('xmlns', svgNS);
  svg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
  svg.setAttribute('width',  W);
  svg.setAttribute('height', H);
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

  // Background tiles
  if (tileImgs.length) {
    const bgGroup = document.createElementNS(svgNS, 'g');
    bgGroup.setAttribute('id', 'map-tiles');
    tileImgs.forEach(t => {
      const img = document.createElementNS(svgNS, 'image');
      img.setAttribute('href', t.dataUrl);
      img.setAttribute('x',      t.px.toFixed(2));
      img.setAttribute('y',      t.py.toFixed(2));
      img.setAttribute('width',  t.tw.toFixed(2));
      img.setAttribute('height', t.tw.toFixed(2));
      img.setAttribute('preserveAspectRatio', 'none');
      bgGroup.appendChild(img);
    });
    svg.appendChild(bgGroup);
  } else if (!includeTiles) {
    // Dark background rect
    const bg = document.createElementNS(svgNS, 'rect');
    bg.setAttribute('width', W); bg.setAttribute('height', H); bg.setAttribute('fill', '#141414');
    svg.appendChild(bg);
  }

  // Clip to artboard
  const defs  = document.createElementNS(svgNS, 'defs');
  const clip  = document.createElementNS(svgNS, 'clipPath');
  clip.setAttribute('id', 'artboard-clip');
  const clipRect = document.createElementNS(svgNS, 'rect');
  clipRect.setAttribute('width', W); clipRect.setAttribute('height', H);
  clip.appendChild(clipRect);
  defs.appendChild(clip);
  svg.insertBefore(defs, svg.firstChild);

  // Draw queries
  S.queries.forEach((q, qi) => {
    if (!q.elements?.length) return;
    const color = COLORS[qi % COLORS.length];
    const group = document.createElementNS(svgNS, 'g');
    group.setAttribute('id', sanitizeId(q.name));
    group.setAttribute('clip-path', 'url(#artboard-clip)');

    (q.elements || []).forEach(el => {
      const name = elName(el);
      const sid  = sanitizeId(name);

      if (el.type === 'node' || forceDots) {
        // Point
        const lat = el.type === 'node' ? el.lat : (el.geometry?.[0]?.lat);
        const lon = el.type === 'node' ? el.lon : (el.geometry?.[0]?.lon);
        if (lat == null || lon == null) return;
        const { x, y } = geoToSvg(lat, lon);
        if (x < -20 || y < -20 || x > W + 20 || y > H + 20) return;
        const circle = document.createElementNS(svgNS, 'circle');
        circle.setAttribute('id', sid);
        circle.setAttribute('cx', x.toFixed(2));
        circle.setAttribute('cy', y.toFixed(2));
        circle.setAttribute('r',  '5');
        circle.setAttribute('fill', color);
        circle.setAttribute('fill-opacity', '0.85');
        circle.setAttribute('stroke', '#fff');
        circle.setAttribute('stroke-width', '1');
        const title = document.createElementNS(svgNS, 'title');
        title.textContent = name;
        circle.appendChild(title);
        group.appendChild(circle);
      } else if (el.type === 'way' && el.geometry) {
        const pts    = el.geometry.map(p => geoToSvg(p.lat, p.lon));
        const pStr   = pts.map(p => `${p.x.toFixed(2)},${p.y.toFixed(2)}`).join(' ');
        const first  = pts[0], last = pts[pts.length - 1];
        const closed = pts.length > 2 && Math.abs(first.x - last.x) < 0.5 && Math.abs(first.y - last.y) < 0.5;
        let shape;
        if (closed && isAreaEl(el.tags)) {
          shape = document.createElementNS(svgNS, 'polygon');
          shape.setAttribute('points', pStr);
          shape.setAttribute('fill', color);
          shape.setAttribute('fill-opacity', '0.2');
          shape.setAttribute('stroke', color);
          shape.setAttribute('stroke-width', '1.5');
        } else {
          shape = document.createElementNS(svgNS, 'polyline');
          shape.setAttribute('points', pStr);
          shape.setAttribute('fill', 'none');
          shape.setAttribute('stroke', color);
          shape.setAttribute('stroke-width', '2');
        }
        shape.setAttribute('id', sid);
        const title = document.createElementNS(svgNS, 'title');
        title.textContent = name;
        shape.appendChild(title);
        group.appendChild(shape);
      } else if (el.type === 'relation' && el.members) {
        const rg = document.createElementNS(svgNS, 'g');
        rg.setAttribute('id', sid);
        el.members.filter(m => m.type === 'way' && m.geometry).forEach((m, mi) => {
          const pts  = m.geometry.map(p => geoToSvg(p.lat, p.lon));
          const pStr = pts.map(p => `${p.x.toFixed(2)},${p.y.toFixed(2)}`).join(' ');
          const line = document.createElementNS(svgNS, 'polyline');
          line.setAttribute('points', pStr);
          line.setAttribute('fill', 'none');
          line.setAttribute('stroke', color);
          line.setAttribute('stroke-width', '2');
          if (mi === 0) { const t = document.createElementNS(svgNS, 'title'); t.textContent = name; line.appendChild(t); }
          rg.appendChild(line);
        });
        group.appendChild(rg);
      }
    });

    svg.appendChild(group);
  });

  const serializer = new XMLSerializer();
  const svgStr     = '<?xml version="1.0" encoding="UTF-8"?>\n' + serializer.serializeToString(svg);
  downloadBlob(svgStr, `overpass-ai-${Date.now()}.svg`, 'image/svg+xml;charset=utf-8;');
  setStatus('SVG exported');
}

function sanitizeId(s) {
  return String(s).replace(/[^a-zA-Z0-9_-]/g, '_').replace(/^([^a-zA-Z_])/, '_$1') || 'element';
}

/* ── Download helper ─────────────────────────────────────────────── */
function downloadBlob(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ── Common export element collector ────────────────────────────── */
function getAllExportElements() {
  const all = [];
  S.queries.forEach((q, qi) => {
    (q.elements || []).forEach(el => {
      const eid = elId(el);
      if (!S.selectedIds.size || S.selectedIds.has(eid)) all.push({ el, qname: q.name, qi });
    });
  });
  return all;
}

/* ── Share URL ──────────────────────────────────────────────────── */
function shareQuery() {
  if (!S.queries.length) { showError('No query to share. Generate a query first.'); return; }
  try {
    const payload = {
      question: S.currentQuestion,
      queries: S.queries.map(q => ({ name: q.name, description: q.description, overpassQL: q.overpassQL, tags: q.tags })),
    };
    const encoded = btoa(encodeURIComponent(JSON.stringify(payload)).replace(/%([0-9A-F]{2})/gi, (_, p1) => String.fromCharCode(parseInt(p1, 16))));
    const url = `${location.origin}${location.pathname}#share=${encoded}`;
    navigator.clipboard.writeText(url).then(() => {
      const btn = document.getElementById('shareBtn');
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Share'; }, 2000);
    }).catch(() => {
      prompt('Copy this share link:', url);
    });
  } catch(e) {
    showError(`Could not create share link: ${e.message}`);
  }
}

function loadShare() {
  const hash = location.hash;
  if (!hash.startsWith('#share=')) return;
  try {
    const encoded = hash.slice('#share='.length);
    const payload = JSON.parse(decodeURIComponent(atob(encoded).replace(/[\x80-\xff]/g, c => `%${c.charCodeAt(0).toString(16).padStart(2,'0')}`)));
    if (!payload.queries?.length) return;
    S.currentQuestion = payload.question || '';
    document.getElementById('questionInput').value = S.currentQuestion;
    document.getElementById('examplesSection').style.display = 'none';
    clearAllLayers();
    S.queries = payload.queries.map(q => ({ ...q, elements: [], layerGroup: null, elementLayers: new Map(), areaFallbacks: [], visible: true }));
    renderQueryOutput(payload.explanation || '', payload.queries);
    // Auto-run the first query
    setTimeout(() => runQuery(0), 300);
  } catch(e) {
    console.warn('Could not load share link:', e);
  }
}

/* ── Saved searches ─────────────────────────────────────────────── */
function saveSearch(question, queries, variantIdx) {
  const entry = {
    id: `${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
    question: question || '',
    queries: queries.map(q => ({ name: q.name, description: q.description, overpassQL: q.overpassQL, tags: q.tags, cachedElements: S.queries.find(sq => sq.overpassQL === q.overpassQL)?.elements || [] })),
    activeVariant: variantIdx,
    savedAt: new Date().toISOString(),
    hidden: false,
  };
  S.savedSearches.unshift(entry);
  persistSavedSearches();
  renderSavedSearches();
}

function deleteSavedSearch(id) {
  S.savedSearches = S.savedSearches.filter(s => s.id !== id);
  persistSavedSearches();
  renderSavedSearches();
}

function toggleSavedSearchHidden(id) {
  const entry = S.savedSearches.find(s => s.id === id);
  if (entry) { entry.hidden = !entry.hidden; persistSavedSearches(); renderSavedSearches(); }
}

function persistSavedSearches() {
  localStorage.setItem('saved_searches', JSON.stringify(S.savedSearches));
}

function _colorForShownSearch(id) {
  // Assign a COLORS slot after the active queries, based on insertion order
  const ids = Object.keys(S.shownSearches);
  const pos = ids.indexOf(id);
  const offset = pos < 0 ? ids.length : pos;
  return COLORS[(S.queries.length + offset) % COLORS.length];
}

function _colorForShownQuery(id, queryIndex) {
  const ids = Object.keys(S.shownSearches);
  const pos = ids.indexOf(id);
  const offset = pos < 0 ? ids.length : pos;
  return COLORS[(S.queries.length + offset + queryIndex) % COLORS.length];
}

async function showSavedSearchOnMap(id) {
  const entry = S.savedSearches.find(s => s.id === id);
  if (!entry || S.shownSearches[id]) return;

  const layerGroups = [];
  const areaFallbacks = [];

  const b = S.map.getBounds();
  const bbox = `${b.getSouth().toFixed(6)},${b.getWest().toFixed(6)},${b.getNorth().toFixed(6)},${b.getEast().toFixed(6)}`;

  // Register early so _colorForShownSearch can compute correct offsets for subsequent calls
  S.shownSearches[id] = { layerGroups, areaFallbacks };
  renderSavedSearches();

  const queriesToRun = entry.queries;
  for (let qi = 0; qi < queriesToRun.length; qi++) {
    const q = queriesToRun[qi];
    const qColor = _colorForShownQuery(id, qi);
    try {
      let elements;
      if (q.cachedElements && q.cachedElements.length > 0) {
        elements = q.cachedElements;
      } else {
        const oql = q.overpassQL.replace(/\{\{bbox\}\}/g, bbox);
        const data = await fetchOverpass(oql);
        elements = (data.elements || []).filter(el =>
          (el.type === 'node' && el.lat != null) ||
          (el.type === 'way'  && el.geometry)    ||
          (el.type === 'relation' && el.members)
        );
      }
      const lg = L.layerGroup().addTo(S.map);
      const MAX_RENDER = 1000;
      elements.slice(0, MAX_RENDER).forEach(el => {
        const eid  = elId(el);
        const name = elName(el);
        let layer  = null;
        if (el.type === 'node') {
          layer = L.circleMarker([el.lat, el.lon], nodeStyle(qColor));
        } else if (el.type === 'way' && el.geometry) {
          const pts = el.geometry.map(p => [p.lat, p.lon]);
          const closed = pts.length > 2 && pts[0][0] === pts[pts.length-1][0] && pts[0][1] === pts[pts.length-1][1];
          if (closed && isAreaEl(el.tags)) {
            layer = L.polygon(pts, polyStyle(qColor));
            const center = layer.getBounds().getCenter();
            const fallback = L.circleMarker([center.lat, center.lng], { ...nodeStyle(qColor), opacity: 0, fillOpacity: 0 });
            fallback.bindPopup(buildPopup(el, name, qColor));
            lg.addLayer(fallback);
            areaFallbacks.push({ poly: layer, fallback, eid, color: qColor });
          } else {
            layer = L.polyline(pts, lineStyle(qColor));
          }
        } else if (el.type === 'relation' && el.members) {
          const ways = el.members.filter(m => m.type === 'way' && m.geometry);
          if (ways.length) layer = L.polyline(ways.map(w => w.geometry.map(p => [p.lat, p.lon])), lineStyle(qColor));
        }
        if (layer) {
          layer.bindPopup(buildPopup(el, name, qColor));
          lg.addLayer(layer);
        }
      });
      layerGroups.push(lg);
    } catch (err) {
      console.warn('showSavedSearchOnMap query error:', err);
      layerGroups.push(null);
    }
  }
  updateAreaDots();
}

function hideSavedSearchFromMap(id) {
  const shown = S.shownSearches[id];
  if (!shown) return;
  shown.layerGroups.forEach(lg => { if (lg) S.map.removeLayer(lg); });
  delete S.shownSearches[id];
  renderSavedSearches();
}

function loadSavedSearch(id) {
  const entry = S.savedSearches.find(s => s.id === id);
  if (!entry) return;
  S.currentQuestion = entry.question;
  document.getElementById('questionInput').value = entry.question;
  document.getElementById('examplesSection').style.display = 'none';
  clearAllLayers();
  S.queries = entry.queries.map(q => ({ ...q, elements: q.cachedElements || [], layerGroup: null, elementLayers: new Map(), areaFallbacks: [], visible: true }));
  renderQueryOutput('', entry.queries);
  const activeIdx = entry.activeVariant ?? 0;
  const cached = S.queries[activeIdx]?.elements;
  if (cached && cached.length > 0) {
    setTimeout(() => {
      setActiveVariant(activeIdx);
      renderOnMap(activeIdx, cached);
      renderResultsList();
      const countLabel = cached.length > 1000
        ? `${cached.length} results (map shows first 1000)`
        : `${cached.length} result${cached.length !== 1 ? 's' : ''}`;
      setVariantCount(activeIdx, countLabel);
      updateStatusResults();
      if (cached.length > 0) fitResults();
    }, 100);
  } else {
    setTimeout(() => runQuery(activeIdx), 100);
  }
}

function renderSavedSearches() {
  const container = document.getElementById('savedList');
  const section   = document.getElementById('savedSection');
  if (!container) return;

  const visible = S.savedSearches.filter(s => !s.hidden);
  const hidden  = S.savedSearches.filter(s => s.hidden);

  // Show section only when there are saved searches
  section.style.display = S.savedSearches.length ? 'block' : 'none';

  container.innerHTML = '';

  if (!S.savedSearches.length) return;

  S.savedSearches.forEach(entry => {
    const date = new Date(entry.savedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    const isShown = !!S.shownSearches[entry.id];
    const shownColor = isShown ? _colorForShownSearch(entry.id) : null;
    // Validate color is a safe CSS hex value (comes from COLORS palette)
    const safeColor = shownColor && /^#[0-9a-fA-F]{3,6}$/.test(shownColor) ? shownColor : '#888';
    const item = document.createElement('div');
    item.className = 'saved-item';
    item.innerHTML = `
      <div class="saved-item-header">
        ${isShown ? `<span class="saved-item-dot" style="background:${safeColor};"></span>` : ''}
        <span class="saved-item-name" title="${esc(entry.question)}">${esc(entry.question || entry.queries[0]?.name || 'Saved search')}</span>
        <span class="saved-item-date">${esc(date)}</span>
        <button class="saved-item-btn${isShown ? ' active' : ''}" data-action="toggle" data-id="${esc(entry.id)}">${isShown ? 'hide' : 'show'}</button>
        <button class="saved-item-btn" data-action="load" data-id="${esc(entry.id)}">load</button>
        <button class="saved-item-btn danger" data-action="delete" data-id="${esc(entry.id)}">✕</button>
      </div>`;
    item.querySelector('.saved-item-name').addEventListener('click', () => { item.classList.toggle('open'); });
    item.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const id = btn.dataset.id;
        if (btn.dataset.action === 'load')   loadSavedSearch(id);
        if (btn.dataset.action === 'delete') deleteSavedSearch(id);
        if (btn.dataset.action === 'toggle') {
          if (S.shownSearches[id]) hideSavedSearchFromMap(id);
          else showSavedSearchOnMap(id);
        }
      });
    });
    container.appendChild(item);
  });
}
function showLoading(text) {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loadingState').style.display = 'block';
  document.getElementById('generateBtn').disabled = true;
  setStatus(text);
}
function hideLoading() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('generateBtn').disabled = false;
}
function showError(msg) {
  document.getElementById('errorText').textContent = msg;
  document.getElementById('errorState').style.display = 'block';
  setStatus('Error');
}
function hideError() { document.getElementById('errorState').style.display = 'none'; }

function esc(s) {
  return String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escXml(s) { return esc(s).replace(/'/g, '&apos;'); }
/** Allow only http/https URLs to prevent javascript: XSS in href attributes */
function safeUrl(url) {
  const s = String(url ?? '').trim();
  return /^https?:\/\//i.test(s) ? s : '#';
}

/* ── Bootstrap ──────────────────────────────────────────────────── */
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
